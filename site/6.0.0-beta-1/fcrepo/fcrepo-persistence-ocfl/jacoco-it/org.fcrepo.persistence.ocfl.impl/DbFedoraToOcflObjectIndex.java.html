<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DbFedoraToOcflObjectIndex.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Fedora Repository OCFL Persistence Impl</a> &gt; <a href="index.source.html" class="el_package">org.fcrepo.persistence.ocfl.impl</a> &gt; <span class="el_source">DbFedoraToOcflObjectIndex.java</span></div><h1>DbFedoraToOcflObjectIndex.java</h1><pre class="source lang-java linenums">/*
 * Licensed to DuraSpace under one or more contributor license agreements.
 * See the NOTICE file distributed with this work for additional information
 * regarding copyright ownership.
 *
 * DuraSpace licenses this file to you under the Apache License,
 * Version 2.0 (the &quot;License&quot;); you may not use this file except in
 * compliance with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.fcrepo.persistence.ocfl.impl;

import java.util.Collections;
import java.util.Map;

import javax.annotation.Nonnull;
import javax.annotation.PostConstruct;
import javax.sql.DataSource;

import org.fcrepo.common.db.DbPlatform;
import org.fcrepo.kernel.api.exception.InvalidResourceIdentifierException;
import org.fcrepo.kernel.api.exception.RepositoryRuntimeException;
import org.fcrepo.kernel.api.identifiers.FedoraId;
import org.fcrepo.persistence.ocfl.api.FedoraOcflMappingNotFoundException;
import org.fcrepo.persistence.ocfl.api.FedoraToOcflObjectIndex;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.dao.DataIntegrityViolationException;
import org.springframework.dao.EmptyResultDataAccessException;
import org.springframework.jdbc.BadSqlGrammarException;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.stereotype.Component;
import org.springframework.transaction.annotation.Transactional;

/**
 * Maps Fedora IDs to the OCFL IDs of the OCFL objects the Fedora resource is stored in. This implementation is backed
 * by a relational database.
 *
 * @author pwinckles
 */
@Component(&quot;ocflIndexImpl&quot;)
public class DbFedoraToOcflObjectIndex implements FedoraToOcflObjectIndex {

<span class="fc" id="L56">    private static final Logger LOGGER = LoggerFactory.getLogger(DbFedoraToOcflObjectIndex.class);</span>

    private static final String MAPPING_TABLE = &quot;ocfl_id_map&quot;;

    private static final String FEDORA_ID_COLUMN = &quot;fedora_id&quot;;

    private static final String FEDORA_ROOT_ID_COLUMN = &quot;fedora_root_id&quot;;

    private static final String OCFL_ID_COLUMN = &quot;ocfl_id&quot;;

    private static final String TRANSACTION_OPERATIONS_TABLE = &quot;ocfl_id_map_session_operations&quot;;

    private static final String TRANSACTION_ID_COLUMN = &quot;session_id&quot;;

    private static final String OPERATION_COLUMN = &quot;operation&quot;;

    /*
     * Lookup all mappings for the resource id.
     */
    private static final String LOOKUP_MAPPING = &quot;SELECT &quot; + FEDORA_ROOT_ID_COLUMN + &quot;, &quot; + OCFL_ID_COLUMN + &quot; FROM &quot; +
            MAPPING_TABLE + &quot; WHERE &quot; + FEDORA_ID_COLUMN + &quot; = :fedoraId&quot;;

    /*
     * Lookup all mappings from the mapping table as well as any new 'add's and excluding any 'delete's in this
     * transaction.
     */
    private static final String LOOKUP_MAPPING_IN_TRANSACTION = &quot;SELECT x.&quot; + FEDORA_ROOT_ID_COLUMN + &quot;,&quot; +
            &quot; x.&quot; + OCFL_ID_COLUMN + &quot; FROM&quot; +
            &quot; (SELECT &quot; + FEDORA_ROOT_ID_COLUMN + &quot;, &quot; + OCFL_ID_COLUMN + &quot; FROM &quot; + MAPPING_TABLE + &quot; WHERE &quot; +
            FEDORA_ID_COLUMN + &quot; = :fedoraId&quot; +
            &quot; UNION SELECT &quot; + FEDORA_ROOT_ID_COLUMN + &quot;, &quot; + OCFL_ID_COLUMN + &quot; FROM &quot; + TRANSACTION_OPERATIONS_TABLE +
            &quot; WHERE &quot; + FEDORA_ID_COLUMN + &quot; = :fedoraId AND &quot; + TRANSACTION_ID_COLUMN + &quot; = :transactionId&quot; +
            &quot; AND &quot; + OPERATION_COLUMN + &quot; = 'add') x&quot;;

    /*
     * Add an 'add' operation to the transaction table.
     */
    private static final String UPSERT_MAPPING_TX_POSTGRESQL = &quot;INSERT INTO &quot; + TRANSACTION_OPERATIONS_TABLE +
            &quot; ( &quot; + FEDORA_ID_COLUMN + &quot;, &quot; + FEDORA_ROOT_ID_COLUMN + &quot;, &quot; + OCFL_ID_COLUMN + &quot;, &quot; +
            TRANSACTION_ID_COLUMN + &quot;, &quot; + OPERATION_COLUMN + &quot;) VALUES (:fedoraId, :fedoraRootId, :ocflId,&quot; +
            &quot; :transactionId, :operation) ON CONFLICT (&quot; + FEDORA_ID_COLUMN + &quot;, &quot; + TRANSACTION_ID_COLUMN + &quot;)&quot; +
            &quot; DO UPDATE SET &quot; + FEDORA_ROOT_ID_COLUMN + &quot; = EXCLUDED.&quot; + FEDORA_ROOT_ID_COLUMN + &quot;, &quot; +
            OCFL_ID_COLUMN + &quot; = EXCLUDED.&quot; + OCFL_ID_COLUMN + &quot;, &quot; + OPERATION_COLUMN + &quot; = EXCLUDED.&quot; +
            OPERATION_COLUMN;

    private static final String UPSERT_MAPPING_TX_MYSQL_MARIA = &quot;INSERT INTO &quot; + TRANSACTION_OPERATIONS_TABLE +
            &quot; (&quot; + FEDORA_ID_COLUMN + &quot;, &quot; + FEDORA_ROOT_ID_COLUMN + &quot;, &quot; + OCFL_ID_COLUMN + &quot;, &quot; +
            TRANSACTION_ID_COLUMN + &quot;, &quot; + OPERATION_COLUMN + &quot;)&quot; +
            &quot; VALUES (:fedoraId, :fedoraRootId, :ocflId, :transactionId, :operation) ON DUPLICATE KEY UPDATE &quot; +
            FEDORA_ROOT_ID_COLUMN + &quot; = VALUES(&quot; + FEDORA_ROOT_ID_COLUMN + &quot;), &quot; + OCFL_ID_COLUMN + &quot; = VALUES(&quot; +
            OCFL_ID_COLUMN + &quot;), &quot; + OPERATION_COLUMN + &quot; = VALUES(&quot; + OPERATION_COLUMN + &quot;)&quot;;

    private static final String UPSERT_MAPPING_TX_H2 = &quot;MERGE INTO &quot; + TRANSACTION_OPERATIONS_TABLE +
            &quot; (&quot; + FEDORA_ID_COLUMN + &quot;, &quot; + FEDORA_ROOT_ID_COLUMN + &quot;, &quot; + OCFL_ID_COLUMN + &quot;, &quot; +
            TRANSACTION_ID_COLUMN + &quot;, &quot; + OPERATION_COLUMN + &quot;)&quot; +
            &quot; KEY (&quot; + FEDORA_ID_COLUMN + &quot;, &quot; + TRANSACTION_ID_COLUMN + &quot;)&quot; +
            &quot; VALUES (:fedoraId, :fedoraRootId, :ocflId, :transactionId, :operation)&quot;;

    /**
     * Map of database product to UPSERT into operations table SQL.
     */
<span class="fc" id="L117">    private static final Map&lt;DbPlatform, String&gt; UPSERT_MAPPING_TX_MAP = Map.of(</span>
            DbPlatform.MYSQL, UPSERT_MAPPING_TX_MYSQL_MARIA,
            DbPlatform.H2, UPSERT_MAPPING_TX_H2,
            DbPlatform.POSTGRESQL, UPSERT_MAPPING_TX_POSTGRESQL,
            DbPlatform.MARIADB, UPSERT_MAPPING_TX_MYSQL_MARIA
    );

    private static final String COMMIT_ADD_MAPPING_POSTGRESQL = &quot;INSERT INTO &quot; + MAPPING_TABLE +
            &quot; ( &quot; + FEDORA_ID_COLUMN + &quot;, &quot; + FEDORA_ROOT_ID_COLUMN + &quot;, &quot; + OCFL_ID_COLUMN + &quot;) SELECT &quot; +
            FEDORA_ID_COLUMN + &quot;, &quot; + FEDORA_ROOT_ID_COLUMN + &quot;, &quot; + OCFL_ID_COLUMN + &quot; FROM &quot; +
            TRANSACTION_OPERATIONS_TABLE + &quot; WHERE &quot; + OPERATION_COLUMN + &quot; = 'add' AND &quot; + TRANSACTION_ID_COLUMN +
            &quot; = :transactionId ON CONFLICT ( &quot; +  FEDORA_ID_COLUMN + &quot; )&quot; +
            &quot; DO UPDATE SET &quot; + FEDORA_ROOT_ID_COLUMN + &quot; = EXCLUDED.&quot; + FEDORA_ROOT_ID_COLUMN + &quot;, &quot; +
            OCFL_ID_COLUMN + &quot; = EXCLUDED.&quot; + OCFL_ID_COLUMN;

    private static final String COMMIT_ADD_MAPPING_MYSQL_MARIA = &quot;INSERT INTO &quot; + MAPPING_TABLE +
            &quot; (&quot; + FEDORA_ID_COLUMN + &quot;, &quot; + FEDORA_ROOT_ID_COLUMN + &quot;, &quot; + OCFL_ID_COLUMN + &quot;) SELECT &quot; +
            FEDORA_ID_COLUMN + &quot;, &quot; + FEDORA_ROOT_ID_COLUMN + &quot;, &quot; + OCFL_ID_COLUMN + &quot; FROM &quot; +
            TRANSACTION_OPERATIONS_TABLE + &quot; WHERE &quot; + OPERATION_COLUMN + &quot; = 'add' AND &quot; + TRANSACTION_ID_COLUMN +
            &quot; = :transactionId ON DUPLICATE KEY UPDATE &quot; +
            FEDORA_ROOT_ID_COLUMN + &quot; = VALUES(&quot; + FEDORA_ROOT_ID_COLUMN + &quot;), &quot; + OCFL_ID_COLUMN + &quot; = VALUES(&quot; +
            OCFL_ID_COLUMN + &quot;)&quot;;

    private static final String COMMIT_ADD_MAPPING_H2 = &quot;MERGE INTO &quot; + MAPPING_TABLE +
            &quot; (&quot; + FEDORA_ID_COLUMN + &quot;, &quot; + FEDORA_ROOT_ID_COLUMN + &quot;, &quot; + OCFL_ID_COLUMN + &quot;)&quot; +
            &quot; SELECT &quot; + FEDORA_ID_COLUMN + &quot;, &quot; + FEDORA_ROOT_ID_COLUMN + &quot;, &quot; + OCFL_ID_COLUMN + &quot; FROM &quot; +
            TRANSACTION_OPERATIONS_TABLE + &quot; WHERE &quot; + OPERATION_COLUMN + &quot; = 'add'&quot;;

    /**
     * Map of database product name to COMMIT to mapping table from operations table
     */
<span class="fc" id="L148">    private static final Map&lt;DbPlatform, String&gt; COMMIT_ADD_MAPPING_MAP = Map.of(</span>
            DbPlatform.MYSQL, COMMIT_ADD_MAPPING_MYSQL_MARIA,
            DbPlatform.H2, COMMIT_ADD_MAPPING_H2,
            DbPlatform.POSTGRESQL, COMMIT_ADD_MAPPING_POSTGRESQL,
            DbPlatform.MARIADB, COMMIT_ADD_MAPPING_MYSQL_MARIA
    );

    /*
     * Delete records from the mapping table that are to be deleted in this transaction.
     */
    private static final String COMMIT_DELETE_RECORDS = &quot;DELETE FROM &quot; + MAPPING_TABLE + &quot; WHERE &quot; +
            &quot;EXISTS (SELECT * FROM &quot; + TRANSACTION_OPERATIONS_TABLE + &quot; WHERE &quot; +
            TRANSACTION_ID_COLUMN + &quot; = :transactionId AND &quot; +  OPERATION_COLUMN + &quot; = 'delete' AND &quot; +
            MAPPING_TABLE + &quot;.&quot; + FEDORA_ID_COLUMN + &quot; = &quot; + TRANSACTION_OPERATIONS_TABLE + &quot;.&quot; + FEDORA_ID_COLUMN +
            &quot;)&quot;;

    private static final String TRUNCATE_MAPPINGS = &quot;TRUNCATE TABLE &quot; + MAPPING_TABLE;

    private static final String TRUNCATE_TRANSACTIONS = &quot;TRUNCATE TABLE &quot; + TRANSACTION_OPERATIONS_TABLE;

    /*
     * Delete all records from the transaction table for the specified transaction.
     */
    private static final String DELETE_ENTIRE_TRANSACTION = &quot;DELETE FROM &quot; + TRANSACTION_OPERATIONS_TABLE + &quot; WHERE &quot; +
            TRANSACTION_ID_COLUMN + &quot; = :transactionId&quot;;

    /*
     * Row mapper for the Lookup queries.
     */
<span class="fc" id="L177">    private static final RowMapper&lt;FedoraOcflMapping&gt; GET_MAPPING_ROW_MAPPER = (resultSet, i) -&gt; new FedoraOcflMapping(</span>
<span class="fc" id="L178">            FedoraId.create(resultSet.getString(1)),</span>
<span class="fc" id="L179">            resultSet.getString(2)</span>
    );

    private final DataSource dataSource;

    private final NamedParameterJdbcTemplate jdbcTemplate;

    private DbPlatform dbPlatform;

<span class="fc" id="L188">    public DbFedoraToOcflObjectIndex(@Autowired final DataSource dataSource) {</span>
<span class="fc" id="L189">        this.dataSource = dataSource;</span>
<span class="fc" id="L190">        this.jdbcTemplate = new NamedParameterJdbcTemplate(dataSource);</span>
<span class="fc" id="L191">    }</span>

    @PostConstruct
    public void setup() {
<span class="fc" id="L195">        dbPlatform = DbPlatform.fromDataSource(dataSource);</span>
<span class="fc" id="L196">    }</span>

    @Override
    public FedoraOcflMapping getMapping(final String transactionId, final FedoraId fedoraId)
            throws FedoraOcflMappingNotFoundException {
        try {
<span class="fc" id="L202">            final MapSqlParameterSource parameterSource = new MapSqlParameterSource();</span>
<span class="fc" id="L203">            parameterSource.addValue(&quot;fedoraId&quot;, fedoraId.getResourceId());</span>
<span class="fc bfc" id="L204" title="All 2 branches covered.">            if (transactionId != null) {</span>
<span class="fc" id="L205">                parameterSource.addValue(&quot;transactionId&quot;, transactionId);</span>
<span class="fc" id="L206">                return jdbcTemplate.queryForObject(LOOKUP_MAPPING_IN_TRANSACTION, parameterSource,</span>
                        GET_MAPPING_ROW_MAPPER);
            } else {
<span class="fc" id="L209">                return jdbcTemplate.queryForObject(LOOKUP_MAPPING, parameterSource, GET_MAPPING_ROW_MAPPER);</span>
            }
<span class="fc" id="L211">        } catch (final EmptyResultDataAccessException e) {</span>
<span class="fc" id="L212">            throw new FedoraOcflMappingNotFoundException(&quot;No OCFL mapping found for &quot; + fedoraId);</span>
        }
    }

    @Override
    public FedoraOcflMapping addMapping(@Nonnull final String transactionId, final FedoraId fedoraId,
                                        final FedoraId fedoraRootId, final String ocflId) {
<span class="fc" id="L219">        upsert(transactionId, fedoraId, &quot;add&quot;, fedoraRootId, ocflId);</span>
<span class="fc" id="L220">        return new FedoraOcflMapping(fedoraRootId, ocflId);</span>
    }

    @Override
    public void removeMapping(@Nonnull final String transactionId, final FedoraId fedoraId) {
<span class="nc" id="L225">        upsert(transactionId, fedoraId, &quot;delete&quot;);</span>
<span class="nc" id="L226">    }</span>

    private void upsert(final String transactionId, final FedoraId fedoraId, final String operation) {
<span class="nc" id="L229">        upsert(transactionId, fedoraId, operation, null, null);</span>
<span class="nc" id="L230">    }</span>

    /**
     * Perform the upsert to the operations table.
     *
     * @param transactionId the transaction/session id.
     * @param fedoraId the resource id.
     * @param operation the operation we are performing (add or delete)
     * @param fedoraRootId the fedora root id (for add only)
     * @param ocflId the ocfl id (for add only).
     */
    private void upsert(final String transactionId, final FedoraId fedoraId, final String operation,
                        final FedoraId fedoraRootId, final String ocflId) {
<span class="fc" id="L243">        final MapSqlParameterSource parameterSource = new MapSqlParameterSource();</span>
<span class="fc" id="L244">        parameterSource.addValue(&quot;fedoraId&quot;, fedoraId.getResourceId());</span>
<span class="pc bpc" id="L245" title="1 of 2 branches missed.">        parameterSource.addValue(&quot;fedoraRootId&quot;, fedoraRootId == null ? null : fedoraRootId.getResourceId());</span>
<span class="fc" id="L246">        parameterSource.addValue(&quot;ocflId&quot;, ocflId);</span>
<span class="fc" id="L247">        parameterSource.addValue(&quot;transactionId&quot;, transactionId);</span>
<span class="fc" id="L248">        parameterSource.addValue(&quot;operation&quot;, operation);</span>
        try {
<span class="fc" id="L250">            jdbcTemplate.update(UPSERT_MAPPING_TX_MAP.get(dbPlatform), parameterSource);</span>
<span class="nc" id="L251">        } catch (final DataIntegrityViolationException | BadSqlGrammarException e) {</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">            if (e.getMessage().contains(&quot;too long for&quot;)) {</span>
<span class="nc" id="L253">                throw new InvalidResourceIdentifierException(&quot;Database error - Fedora ID path too long&quot;,e);</span>
            } else {
<span class="nc" id="L255">                throw new RepositoryRuntimeException(&quot;Database error - error during upsert&quot;,e);</span>
            }
<span class="fc" id="L257">        }</span>
<span class="fc" id="L258">    }</span>

    @Transactional
    @Override
    public void reset() {
        try {
<span class="nc" id="L264">            jdbcTemplate.update(TRUNCATE_MAPPINGS, Collections.emptyMap());</span>
<span class="nc" id="L265">            jdbcTemplate.update(TRUNCATE_TRANSACTIONS, Collections.emptyMap());</span>
<span class="nc" id="L266">        } catch (final Exception e) {</span>
<span class="nc" id="L267">            throw new RepositoryRuntimeException(&quot;Failed to truncate FedoraToOcfl index tables&quot;, e);</span>
<span class="nc" id="L268">        }</span>
<span class="nc" id="L269">    }</span>

    @Transactional
    @Override
    public void commit(@Nonnull final String sessionId) {
<span class="fc" id="L274">        LOGGER.debug(&quot;Committing FedoraToOcfl index changes from transaction {}&quot;, sessionId);</span>
<span class="fc" id="L275">        final Map&lt;String, String&gt; map = Map.of(&quot;transactionId&quot;, sessionId);</span>
        try {
<span class="fc" id="L277">            jdbcTemplate.update(COMMIT_DELETE_RECORDS, map);</span>
<span class="fc" id="L278">            jdbcTemplate.update(COMMIT_ADD_MAPPING_MAP.get(dbPlatform), map);</span>
<span class="fc" id="L279">            jdbcTemplate.update(DELETE_ENTIRE_TRANSACTION, map);</span>
<span class="nc" id="L280">        } catch (final Exception e) {</span>
<span class="nc" id="L281">            LOGGER.warn(&quot;Unable to commit FedoraToOcfl index transaction {}: {}&quot;, sessionId, e.getMessage());</span>
<span class="nc" id="L282">            throw new RepositoryRuntimeException(&quot;Unable to commit FedoraToOcfl index transaction&quot;, e);</span>
<span class="fc" id="L283">        }</span>
<span class="fc" id="L284">    }</span>

    @Override
    public void rollback(@Nonnull final String sessionId) {
<span class="nc" id="L288">        jdbcTemplate.update(DELETE_ENTIRE_TRANSACTION, Map.of(&quot;transactionId&quot;, sessionId));</span>
<span class="nc" id="L289">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>