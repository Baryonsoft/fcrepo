<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>JsonLDEventMessage.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Fedora Repository JMS Module</a> &gt; <a href="../index.html" class="el_bundle">fcrepo-event-serialization</a> &gt; <a href="index.source.html" class="el_package">org.fcrepo.event.serialization</a> &gt; <span class="el_source">JsonLDEventMessage.java</span></div><h1>JsonLDEventMessage.java</h1><pre class="source lang-java linenums">/*
 * Licensed to DuraSpace under one or more contributor license agreements.
 * See the NOTICE file distributed with this work for additional information
 * regarding copyright ownership.
 *
 * DuraSpace licenses this file to you under the Apache License,
 * Version 2.0 (the &quot;License&quot;); you may not use this file except in
 * compliance with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.fcrepo.event.serialization;

import static java.util.Collections.singletonList;
import static java.util.stream.Collectors.toList;
import static org.fcrepo.http.commons.api.rdf.HttpResourceConverter.convertToExternalPath;
import static org.fcrepo.kernel.api.RdfLexicon.PROV_NAMESPACE;
import static org.fcrepo.kernel.api.observer.OptionalValues.BASE_URL;
import static org.fcrepo.kernel.api.observer.OptionalValues.USER_AGENT;
import static org.slf4j.LoggerFactory.getLogger;

import java.time.Instant;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

import org.fcrepo.kernel.api.observer.FedoraEvent;

import org.slf4j.Logger;

import com.fasterxml.jackson.annotation.JsonIgnore;
import com.fasterxml.jackson.annotation.JsonProperty;

/**
 * A structure used for serializing a FedoraEvent into JSON
 * 
 * @author acoburn
 * @author dbernstein
 */
<span class="fc" id="L47">class JsonLDEventMessage {</span>

    @JsonIgnore
<span class="fc" id="L50">    private static final Logger LOGGER = getLogger(JsonLDEventMessage.class);</span>

    private static final String ACTIVITYSTREAMS_NS = &quot;https://www.w3.org/ns/activitystreams&quot;;

    static class ContextElement {

        @JsonProperty(&quot;@id&quot;)
        public final String id;

        @JsonProperty(&quot;@type&quot;)
        public final String type;

<span class="fc" id="L62">        public ContextElement(final String id) {</span>
<span class="fc" id="L63">            this.id = id;</span>
<span class="fc" id="L64">            this.type = &quot;@id&quot;;</span>
<span class="fc" id="L65">        }</span>

<span class="nc" id="L67">        public ContextElement(final String id, final String type) {</span>
<span class="nc" id="L68">            this.id = id;</span>
<span class="nc" id="L69">            this.type = type;</span>
<span class="nc" id="L70">        }</span>
    }

<span class="fc" id="L73">    static class Context {</span>

<span class="fc" id="L75">        public final String prov = &quot;http://www.w3.org/ns/prov#&quot;;</span>

<span class="fc" id="L77">        public final String dcterms = &quot;http://purl.org/dc/terms/&quot;;</span>

<span class="fc" id="L79">        public final String type = &quot;@type&quot;;</span>

<span class="fc" id="L81">        public final String id = &quot;@id&quot;;</span>

<span class="fc" id="L83">        public final ContextElement isPartOf = new ContextElement(&quot;dcterms:isPartOf&quot;);</span>

    }

    static class Object {

        @JsonProperty(&quot;type&quot;)
        public List&lt;String&gt; type;

        @JsonProperty(&quot;id&quot;)
        public String id;

        @JsonProperty(&quot;isPartOf&quot;)
        public String isPartOf;

<span class="fc" id="L98">        public Object(final String id, final List&lt;String&gt; type, final String isPartOf) {</span>
<span class="fc" id="L99">            this.type = type;</span>
<span class="fc" id="L100">            this.id = id;</span>
<span class="fc" id="L101">            this.isPartOf = isPartOf;</span>
<span class="fc" id="L102">        }</span>
    }

    static class Actor {

        @JsonProperty(&quot;type&quot;)
        public List&lt;String&gt; type;

<span class="fc" id="L110">        public Actor(final List&lt;String&gt; type) {</span>
<span class="fc" id="L111">            this.type = type;</span>
<span class="fc" id="L112">        }</span>
    }

    static class Application extends Actor {

        @JsonProperty(&quot;name&quot;)
        public String name;

        public Application(final String name, final List&lt;String&gt; type) {
<span class="fc" id="L121">            super(type);</span>
<span class="fc" id="L122">            this.name = name;</span>
<span class="fc" id="L123">        }</span>
    }

    static class Person extends Actor {

        @JsonProperty(&quot;id&quot;)
        public String id;

        public Person(final String id, final List&lt;String&gt; type) {
<span class="fc" id="L132">            super(type);</span>
<span class="fc" id="L133">            this.id = id;</span>
<span class="fc" id="L134">        }</span>
    }

    @JsonProperty(&quot;id&quot;)
    public String id;

    @JsonProperty(&quot;type&quot;)
    public List&lt;String&gt; type;

    @JsonProperty(&quot;name&quot;)
    public String name;

    @JsonProperty(&quot;published&quot;)
    public Instant published;


    @JsonProperty(&quot;actor&quot;)
    public List&lt;Actor&gt; actor;

    @JsonProperty(&quot;object&quot;)
    public Object object;

    @JsonProperty(&quot;@context&quot;)
    public List&lt;java.lang.Object&gt; context;

    /**
     * Populate a JsonLDEventMessage from a FedoraEvent
     * 
     * @param evt The Fedora event
     * @return a JsonLDEventMessage
     */
    public static JsonLDEventMessage from(final FedoraEvent evt) {

<span class="fc" id="L167">        final String baseUrl = evt.getInfo().get(BASE_URL);</span>

        // build objectId
<span class="fc" id="L170">        final String objectId = convertToExternalPath(baseUrl + evt.getPath());</span>
        // build event types list
<span class="fc" id="L172">        final List&lt;String&gt; types = evt.getTypes()</span>
<span class="fc" id="L173">                .stream()</span>
<span class="fc" id="L174">                .map(rdfType -&gt; rdfType.getTypeAbbreviated())</span>
<span class="fc" id="L175">                .collect(toList());</span>
        // comma-separated list for names of events (since name requires string rather than array)
<span class="fc" id="L177">        final String name = String.join(&quot;, &quot;, evt.getTypes()</span>
<span class="fc" id="L178">                .stream()</span>
<span class="fc" id="L179">                .map(rdfType -&gt; rdfType.getName())</span>
<span class="fc" id="L180">                .collect(toList()));</span>
        // build resource types list
<span class="fc" id="L182">        final List&lt;String&gt; resourceTypes = new ArrayList&lt;&gt;(evt.getResourceTypes());</span>
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">        if (!resourceTypes.contains(PROV_NAMESPACE + &quot;Entity&quot;)) {</span>
<span class="fc" id="L184">            resourceTypes.add(PROV_NAMESPACE + &quot;Entity&quot;);</span>
        }

        // build actors list
<span class="fc" id="L188">        final List&lt;Actor&gt; actor = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L189">        actor.add(new Person(evt.getUserURI().toString(), singletonList(&quot;Person&quot;)));</span>
<span class="fc" id="L190">        final String softwareAgent = evt.getInfo().get(USER_AGENT);</span>
<span class="fc bfc" id="L191" title="All 2 branches covered.">        if (softwareAgent != null) {</span>
<span class="fc" id="L192">            actor.add(new Application(softwareAgent, singletonList(&quot;Application&quot;)));</span>
        }

<span class="fc" id="L195">        final JsonLDEventMessage msg = new JsonLDEventMessage();</span>

<span class="fc" id="L197">        msg.id = evt.getEventID();</span>
<span class="fc" id="L198">        msg.context = Arrays.asList(ACTIVITYSTREAMS_NS, new Context());</span>
<span class="fc" id="L199">        msg.actor = actor;</span>
<span class="fc" id="L200">        msg.published = evt.getDate();</span>
<span class="fc" id="L201">        msg.type = types;</span>
<span class="fc" id="L202">        msg.name = name;</span>
<span class="fc" id="L203">        msg.object = new Object(objectId, resourceTypes, baseUrl);</span>
<span class="fc" id="L204">        return msg;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>