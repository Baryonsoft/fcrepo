<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>PreferTag.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Fedora Event Serialization</a> &gt; <a href="../index.html" class="el_bundle">fcrepo-http-commons</a> &gt; <a href="index.source.html" class="el_package">org.fcrepo.http.commons.domain</a> &gt; <span class="el_source">PreferTag.java</span></div><h1>PreferTag.java</h1><pre class="source lang-java linenums">/*
 * Licensed to DuraSpace under one or more contributor license agreements.
 * See the NOTICE file distributed with this work for additional information
 * regarding copyright ownership.
 *
 * DuraSpace licenses this file to you under the Apache License,
 * Version 2.0 (the &quot;License&quot;); you may not use this file except in
 * compliance with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.fcrepo.http.commons.domain;

import static java.util.Arrays.asList;
import static java.util.Optional.ofNullable;
import static org.fcrepo.kernel.api.RdfLexicon.LDP_NAMESPACE;
import static org.fcrepo.kernel.api.RdfLexicon.PREFER_SERVER_MANAGED;
import static org.fcrepo.kernel.api.RdfLexicon.EMBED_CONTAINED;
import static org.fcrepo.kernel.api.RdfLexicon.INBOUND_REFERENCES;

import org.glassfish.jersey.message.internal.HttpHeaderReader;

import javax.servlet.http.HttpServletResponse;

import java.text.ParseException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;

/**
 * Parse a single prefer tag, value and any optional parameters
 *
 * @author cabeer
 */
public class PreferTag implements Comparable&lt;PreferTag&gt; {
    private final String tag;
<span class="fc" id="L44">    private String value = &quot;&quot;;</span>
<span class="fc" id="L45">    private Map&lt;String, String&gt; params = new HashMap&lt;&gt;();</span>

    /**
     * Create an empty PreferTag
     * @return the empty PreferTag
     */
    public static PreferTag emptyTag() {
<span class="fc" id="L52">        return new PreferTag((String)null);</span>
    }

    /**
     * Create a new PreferTag from an existing tag
     * @param preferTag the preferTag
     */
<span class="fc" id="L59">    protected PreferTag(final PreferTag preferTag) {</span>
<span class="fc" id="L60">        tag = preferTag.getTag();</span>
<span class="fc" id="L61">        value = preferTag.getValue();</span>
<span class="fc" id="L62">        params = preferTag.getParams();</span>
<span class="fc" id="L63">    }</span>

    /**
     * Parse the prefer tag and parameters out of the header
     * @param reader the reader
     */
<span class="fc" id="L69">    private PreferTag(final HttpHeaderReader reader) {</span>

        // Skip any white space
<span class="fc" id="L72">        reader.hasNext();</span>

<span class="fc bfc" id="L74" title="All 2 branches covered.">        if (reader.hasNext()) {</span>
            try {
<span class="fc" id="L76">                tag = Optional.ofNullable(reader.nextToken())</span>
<span class="fc" id="L77">                          .map(CharSequence::toString).orElse(null);</span>

<span class="pc bpc" id="L79" title="1 of 2 branches missed.">                if (reader.hasNextSeparator('=', true)) {</span>
<span class="fc" id="L80">                    reader.next();</span>

<span class="fc" id="L82">                    value = Optional.ofNullable(reader.nextTokenOrQuotedString())</span>
<span class="fc" id="L83">                            .    map(CharSequence::toString)</span>
<span class="fc" id="L84">                                .orElse(null);</span>
                }

<span class="fc bfc" id="L87" title="All 2 branches covered.">                if (reader.hasNext()) {</span>
<span class="fc" id="L88">                    params = HttpHeaderReader.readParameters(reader);</span>
<span class="fc bfc" id="L89" title="All 2 branches covered.">                    if ( params == null ) {</span>
<span class="fc" id="L90">                        params = new HashMap&lt;&gt;();</span>
                    }
                }
<span class="nc" id="L93">            } catch (ParseException e) {</span>
<span class="nc" id="L94">                throw new IllegalArgumentException(&quot;Could not parse 'Prefer' header&quot;, e);</span>
<span class="fc" id="L95">            }</span>
        } else {
<span class="fc" id="L97">            tag = &quot;&quot;;</span>
        }
<span class="fc" id="L99">    }</span>

    /**
     * Create a blank prefer tag
     * @param inputTag the input tag
     */
    public PreferTag(final String inputTag) {
<span class="fc" id="L106">        this(HttpHeaderReader.newInstance(inputTag));</span>
<span class="fc" id="L107">    }</span>

    /**
     * Get the tag name
     * @return tag name
     */
    public String getTag() {
<span class="fc" id="L114">        return tag;</span>
    }

    /**
     * Get the default value for the tag
     * @return default value for the tag
     */
    public String getValue() {
<span class="fc" id="L122">        return value;</span>
    }

    /**
     * Get any additional parameters for the prefer tag
     * @return additional parameters for the prefer tag
     */
    public Map&lt;String,String&gt; getParams() {
<span class="fc" id="L130">        return params;</span>
    }

    /**
     * Add appropriate response headers to indicate that the incoming preferences were acknowledged
     * @param servletResponse the servlet response
     */
    public void addResponseHeaders(final HttpServletResponse servletResponse) {

<span class="nc" id="L139">        final String receivedParam = ofNullable(params.get(&quot;received&quot;)).orElse(&quot;&quot;);</span>
<span class="nc" id="L140">        final List&lt;String&gt; includes = asList(ofNullable(params.get(&quot;include&quot;)).orElse(&quot; &quot;).split(&quot; &quot;));</span>
<span class="nc" id="L141">        final List&lt;String&gt; omits = asList(ofNullable(params.get(&quot;omit&quot;)).orElse(&quot; &quot;).split(&quot; &quot;));</span>

<span class="nc" id="L143">        final StringBuilder includeBuilder = new StringBuilder();</span>
<span class="nc" id="L144">        final StringBuilder omitBuilder = new StringBuilder();</span>

<span class="nc bnc" id="L146" title="All 4 branches missed.">        if (!(value.equals(&quot;minimal&quot;) || receivedParam.equals(&quot;minimal&quot;))) {</span>
<span class="nc" id="L147">            final List&lt;String&gt; appliedPrefs = asList(PREFER_SERVER_MANAGED.toString(),</span>
                    LDP_NAMESPACE + &quot;PreferMinimalContainer&quot;,
                    LDP_NAMESPACE + &quot;PreferMembership&quot;,
                    LDP_NAMESPACE + &quot;PreferContainment&quot;);
<span class="nc" id="L151">            final List&lt;String&gt; includePrefs = asList(EMBED_CONTAINED.toString(),</span>
<span class="nc" id="L152">                    INBOUND_REFERENCES.toString());</span>
<span class="nc" id="L153">            includes.forEach(param -&gt; includeBuilder.append(</span>
<span class="nc bnc" id="L154" title="All 4 branches missed.">                    (appliedPrefs.contains(param) || includePrefs.contains(param)) ? param + &quot; &quot; : &quot;&quot;));</span>

            // Note: include params prioritized over omits during implementation
<span class="nc" id="L157">            omits.forEach(param -&gt; omitBuilder.append(</span>
<span class="nc bnc" id="L158" title="All 4 branches missed.">                    (appliedPrefs.contains(param) &amp;&amp; !includes.contains(param)) ? param + &quot; &quot; : &quot;&quot;));</span>
        }

        // build the header for Preference Applied
<span class="nc bnc" id="L162" title="All 2 branches missed.">        final String appliedReturn = value.equals(&quot;minimal&quot;) ? &quot;return=minimal&quot; : &quot;return=representation&quot;;</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">        final String appliedReceived = receivedParam.equals(&quot;minimal&quot;) ? &quot;received=minimal&quot; : &quot;&quot;;</span>

<span class="nc" id="L165">        final StringBuilder preferenceAppliedBuilder = new StringBuilder(appliedReturn);</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">        preferenceAppliedBuilder.append(appliedReceived.length() &gt; 0 ? &quot;; &quot; + appliedReceived : &quot;&quot;);</span>
<span class="nc" id="L167">        appendHeaderParam(preferenceAppliedBuilder, &quot;include&quot;, includeBuilder.toString().trim());</span>
<span class="nc" id="L168">        appendHeaderParam(preferenceAppliedBuilder, &quot;omit&quot;, omitBuilder.toString().trim());</span>

<span class="nc" id="L170">        servletResponse.addHeader(&quot;Preference-Applied&quot;, preferenceAppliedBuilder.toString().trim());</span>

<span class="nc" id="L172">        servletResponse.addHeader(&quot;Vary&quot;, &quot;Prefer&quot;);</span>
<span class="nc" id="L173">    }</span>

    private void appendHeaderParam(final StringBuilder builder, final String paramName, final String paramValue) {
<span class="nc bnc" id="L176" title="All 2 branches missed.">        if (paramValue.length() &gt; 0) {</span>
<span class="nc" id="L177">            builder.append(&quot;; &quot; + paramName + &quot;=\&quot;&quot; + paramValue.trim() + &quot;\&quot;&quot;);</span>
        }
<span class="nc" id="L179">    }</span>

    /**
     * We consider tags with the same name to be equal, because &lt;a
     * href=&quot;http://tools.ietf.org/html/rfc7240#page-4&quot;&gt;the definition of Prefer headers&lt;/a&gt; does not permit that tags
     * with the same name be consumed except by selecting for the first appearing tag.
     *
     * @see java.lang.Comparable#compareTo(java.lang.Object)
     */
    @Override
    public int compareTo(final PreferTag otherTag) {
<span class="fc" id="L190">        return getTag().compareTo(otherTag.getTag());</span>
    }

    @Override
    public boolean equals(final Object obj) {
<span class="fc bfc" id="L195" title="All 2 branches covered.">        if ((obj instanceof PreferTag)) {</span>
<span class="fc" id="L196">            return getTag().equals(((PreferTag) obj).getTag());</span>
        }
<span class="fc" id="L198">        return false;</span>
    }

    @Override
    public int hashCode() {
<span class="pc bpc" id="L203" title="1 of 2 branches missed.">        if (getTag() == null) {</span>
<span class="nc" id="L204">            return 0;</span>
        }
<span class="fc" id="L206">        return getTag().hashCode();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>