<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>FedoraEventImpl.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Fedora Repository Kernel Implementation (ModeShape)</a> &gt; <a href="index.source.html" class="el_package">org.fcrepo.kernel.modeshape.observer</a> &gt; <span class="el_source">FedoraEventImpl.java</span></div><h1>FedoraEventImpl.java</h1><pre class="source lang-java linenums">/*
 * Licensed to DuraSpace under one or more contributor license agreements.
 * See the NOTICE file distributed with this work for additional information
 * regarding copyright ownership.
 *
 * DuraSpace licenses this file to you under the Apache License,
 * Version 2.0 (the &quot;License&quot;); you may not use this file except in
 * compliance with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.fcrepo.kernel.modeshape.observer;

import static com.google.common.base.MoreObjects.toStringHelper;
import static org.fcrepo.kernel.api.observer.EventType.RESOURCE_CREATION;
import static org.fcrepo.kernel.api.observer.EventType.RESOURCE_DELETION;
import static org.fcrepo.kernel.api.observer.EventType.RESOURCE_MODIFICATION;
import static org.fcrepo.kernel.api.observer.EventType.RESOURCE_RELOCATION;
import static org.fcrepo.kernel.api.observer.OptionalValues.BASE_URL;
import static org.fcrepo.kernel.api.observer.OptionalValues.USER_AGENT;
import static javax.jcr.observation.Event.NODE_ADDED;
import static javax.jcr.observation.Event.NODE_MOVED;
import static javax.jcr.observation.Event.NODE_REMOVED;
import static javax.jcr.observation.Event.PROPERTY_ADDED;
import static javax.jcr.observation.Event.PROPERTY_CHANGED;
import static javax.jcr.observation.Event.PROPERTY_REMOVED;
import static org.modeshape.jcr.api.JcrConstants.JCR_CONTENT;
import static org.slf4j.LoggerFactory.getLogger;
import static java.time.Instant.ofEpochMilli;
import static java.util.Arrays.asList;
import static java.util.Collections.emptyMap;
import static java.util.Collections.singleton;
import static java.util.Objects.isNull;
import static java.util.Objects.requireNonNull;
import static java.util.UUID.randomUUID;
import static java.util.stream.Collectors.joining;
import static java.util.stream.Collectors.toSet;
import static java.util.stream.Stream.empty;

import java.io.IOException;
import java.time.Instant;
import java.util.Collection;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.stream.Stream;

import javax.jcr.RepositoryException;
import javax.jcr.nodetype.NodeType;
import javax.jcr.observation.Event;

import org.fcrepo.kernel.api.exception.RepositoryRuntimeException;
import org.fcrepo.kernel.api.observer.EventType;
import org.fcrepo.kernel.api.observer.FedoraEvent;
import org.fcrepo.kernel.modeshape.identifiers.HashConverter;
import org.slf4j.Logger;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.JsonNode;
import com.google.common.collect.ImmutableMap;

/**
 * A very simple abstraction to prevent event-driven machinery downstream from the repository from relying directly
 * on a JCR interface {@link Event}. Can represent either a single JCR event or several.
 *
 * @author ajs6f
 * @since Feb 19, 2013
 */
public class FedoraEventImpl implements FedoraEvent {

<span class="fc" id="L78">    private final static ObjectMapper MAPPER = new ObjectMapper();</span>

<span class="fc" id="L80">    private final static Logger LOGGER = getLogger(FedoraEventImpl.class);</span>

    private final String path;
    private final String userID;
    private final Instant date;
    private final Map&lt;String, String&gt; info;
    private final String eventID;
    private final Set&lt;String&gt; eventResourceTypes;

<span class="fc" id="L89">    private final Set&lt;EventType&gt; eventTypes = new HashSet&lt;&gt;();</span>

<span class="fc" id="L91">    private static final List&lt;Integer&gt; PROPERTY_TYPES = asList(Event.PROPERTY_ADDED,</span>
<span class="fc" id="L92">            Event.PROPERTY_CHANGED, Event.PROPERTY_REMOVED);</span>

    /**
     * Create a new FedoraEvent
     * @param type the Fedora EventType
     * @param path the node path corresponding to this event
     * @param resourceTypes the rdf types of the corresponding resource
     * @param userID the acting user for this event
     * @param date the timestamp for this event
     * @param info supplementary information
     */
    public FedoraEventImpl(final EventType type, final String path, final Set&lt;String&gt; resourceTypes,
            final String userID, final Instant date, final Map&lt;String, String&gt; info) {
<span class="fc" id="L105">        this(singleton(type), path, resourceTypes, userID, date, info);</span>
<span class="fc" id="L106">    }</span>

   /**
     * Create a new FedoraEvent
     * @param types a collection of Fedora EventTypes
     * @param path the node path corresponding to this event
     * @param resourceTypes the rdf types of the corresponding resource
     * @param userID the acting user for this event
     * @param date the timestamp for this event
     * @param info supplementary information
     */
    public FedoraEventImpl(final Collection&lt;EventType&gt; types, final String path, final Set&lt;String&gt; resourceTypes,
<span class="fc" id="L118">            final String userID, final Instant date, final Map&lt;String, String&gt; info) {</span>
<span class="fc" id="L119">        requireNonNull(types, &quot;FedoraEvent requires a non-null event type&quot;);</span>
<span class="fc" id="L120">        requireNonNull(path, &quot;FedoraEvent requires a non-null path&quot;);</span>

<span class="fc" id="L122">        this.eventTypes.addAll(types);</span>
<span class="fc" id="L123">        this.path = path;</span>
<span class="fc" id="L124">        this.eventResourceTypes = resourceTypes;</span>
<span class="fc" id="L125">        this.userID = userID;</span>
<span class="fc" id="L126">        this.date = date;</span>
<span class="pc bpc" id="L127" title="1 of 2 branches missed.">        this.info = isNull(info) ? emptyMap() : info;</span>
<span class="fc" id="L128">        this.eventID = &quot;urn:uuid:&quot; + randomUUID().toString();</span>
<span class="fc" id="L129">    }</span>


    /**
     * @return the event types of the underlying JCR {@link Event}s
     */
    @Override
    public Set&lt;EventType&gt; getTypes() {
<span class="fc" id="L137">        return eventTypes;</span>
    }

    /**
     * @return the RDF types of the underlying Fedora Resource
    **/
    @Override
    public Set&lt;String&gt; getResourceTypes() {
<span class="fc" id="L145">        return eventResourceTypes;</span>
    }

    /**
     * @return the path of the underlying JCR {@link Event}s
     */
    @Override
    public String getPath() {
<span class="fc" id="L153">        return path;</span>
    }

    /**
     * @return the user ID of the underlying JCR {@link Event}s
     */
    @Override
    public String getUserID() {
<span class="fc" id="L161">        return userID;</span>
    }

    /**
     * @return the date of the FedoraEvent
     */
    @Override
    public Instant getDate() {
<span class="fc" id="L169">        return date;</span>
    }

    /**
     * Get the event ID.
     * @return Event identifier to use for building event URIs (e.g., in an external triplestore).
    **/
    @Override
    public String getEventID() {
<span class="nc" id="L178">        return eventID;</span>
    }

    /**
     * Return a Map with any additional information about the event.
     * @return a Map of additional information.
     */
    @Override
    public Map&lt;String, String&gt; getInfo() {

<span class="fc" id="L188">        return info;</span>
    }

    @Override
    public String toString() {

<span class="nc" id="L194">        return toStringHelper(this)</span>
<span class="nc" id="L195">            .add(&quot;Event types:&quot;, getTypes().stream()</span>
<span class="nc" id="L196">                            .map(EventType::getName)</span>
<span class="nc" id="L197">                            .collect(joining(&quot;, &quot;)))</span>
<span class="nc" id="L198">            .add(&quot;Event resource types:&quot;, String.join(&quot;,&quot;, eventResourceTypes))</span>
<span class="nc" id="L199">            .add(&quot;Path:&quot;, getPath())</span>
<span class="nc" id="L200">            .add(&quot;Date: &quot;, getDate()).toString();</span>
    }

<span class="fc" id="L203">    private static final Map&lt;Integer, EventType&gt; translation = ImmutableMap.&lt;Integer, EventType&gt;builder()</span>
<span class="fc" id="L204">            .put(NODE_ADDED, RESOURCE_CREATION)</span>
<span class="fc" id="L205">            .put(NODE_REMOVED, RESOURCE_DELETION)</span>
<span class="fc" id="L206">            .put(PROPERTY_ADDED, RESOURCE_MODIFICATION)</span>
<span class="fc" id="L207">            .put(PROPERTY_REMOVED, RESOURCE_MODIFICATION)</span>
<span class="fc" id="L208">            .put(PROPERTY_CHANGED, RESOURCE_MODIFICATION)</span>
<span class="fc" id="L209">            .put(NODE_MOVED, RESOURCE_RELOCATION).build();</span>

    /**
     * Get the Fedora event type for a JCR type
     *
     * @param i the integer value of a JCR type
     * @return EventType
     */
    public static EventType valueOf(final Integer i) {
<span class="fc" id="L218">        final EventType type = translation.get(i);</span>
<span class="pc bpc" id="L219" title="1 of 2 branches missed.">        if (isNull(type)) {</span>
<span class="nc" id="L220">            throw new IllegalArgumentException(&quot;Invalid event type: &quot; + i);</span>
        }
<span class="fc" id="L222">        return type;</span>
    }


    /**
     * Convert a JCR Event to a FedoraEvent
     * @param event the JCR Event
     * @return a FedoraEvent
     */
    public static FedoraEvent from(final Event event) {
<span class="fc" id="L232">        requireNonNull(event);</span>
        try {
            @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L235">            final Map&lt;String, String&gt; info = new HashMap&lt;&gt;(event.getInfo());</span>

<span class="fc" id="L237">            final String userdata = event.getUserData();</span>
            try {
<span class="pc bpc" id="L239" title="1 of 4 branches missed.">                if (userdata != null &amp;&amp; !userdata.isEmpty()) {</span>
<span class="fc" id="L240">                    final JsonNode json = MAPPER.readTree(userdata);</span>
<span class="pc bpc" id="L241" title="1 of 2 branches missed.">                    if (json.has(BASE_URL)) {</span>
<span class="nc" id="L242">                        String url = json.get(BASE_URL).asText();</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">                        while (url.endsWith(&quot;/&quot;)) {</span>
<span class="nc" id="L244">                            url = url.substring(0, url.length() - 1);</span>
                        }
<span class="nc" id="L246">                        info.put(BASE_URL, url);</span>
                    }
<span class="pc bpc" id="L248" title="1 of 2 branches missed.">                    if (json.has(USER_AGENT)) {</span>
<span class="nc" id="L249">                        info.put(USER_AGENT, json.get(USER_AGENT).asText());</span>
                    }
<span class="fc" id="L251">                } else {</span>
<span class="fc" id="L252">                    LOGGER.debug(&quot;Event UserData is empty!&quot;);</span>
                }
<span class="nc" id="L254">            } catch (final IOException ex) {</span>
<span class="nc" id="L255">                LOGGER.warn(&quot;Error extracting user data: &quot; + userdata, ex.getMessage());</span>
<span class="fc" id="L256">            }</span>

<span class="fc" id="L258">            final Set&lt;String&gt; resourceTypes = getResourceTypes(event).collect(toSet());</span>

<span class="fc" id="L260">            return new FedoraEventImpl(valueOf(event.getType()), cleanPath(event), resourceTypes,</span>
<span class="fc" id="L261">                    event.getUserID(), ofEpochMilli(event.getDate()), info);</span>

<span class="nc" id="L263">        } catch (final RepositoryException ex) {</span>
<span class="nc" id="L264">            throw new RepositoryRuntimeException(&quot;Error converting JCR Event to FedoraEvent&quot;, ex);</span>
        }
    }

    /**
     * Get the RDF Types of the resource corresponding to this JCR Event
     * @param event the JCR event
     * @return the types recorded on the resource associated to this event
     */
    public static Stream&lt;String&gt; getResourceTypes(final Event event) {
<span class="pc bpc" id="L274" title="1 of 2 branches missed.">        if (event instanceof org.modeshape.jcr.api.observation.Event) {</span>
            try {
<span class="fc" id="L276">                final org.modeshape.jcr.api.observation.Event modeEvent =</span>
                        (org.modeshape.jcr.api.observation.Event) event;
<span class="fc" id="L278">                final Stream.Builder&lt;NodeType&gt; types = Stream.builder();</span>
<span class="fc bfc" id="L279" title="All 2 branches covered.">                for (final NodeType type : modeEvent.getMixinNodeTypes()) {</span>
<span class="fc" id="L280">                    types.add(type);</span>
                }
<span class="fc" id="L282">                types.add(modeEvent.getPrimaryNodeType());</span>
<span class="fc" id="L283">                return types.build().map(NodeType::getName);</span>
<span class="nc" id="L284">            } catch (final RepositoryException e) {</span>
<span class="nc" id="L285">                throw new RepositoryRuntimeException(e);</span>
            }
        }
<span class="nc" id="L288">        return empty(); // wasn't a ModeShape event, so we have no access to resource types</span>
    }

    /**
     * The JCR-based Event::getPath contains some Modeshape artifacts that must be removed or modified in
     * order to correspond to the public resource path. For example, JCR Events will contain a trailing
     * /jcr:content for Binaries, a trailing /propName for properties, and /#/ notation for URI fragments.
     */
    private static String cleanPath(final Event event) throws RepositoryException {
        // remove any trailing data for property changes
<span class="fc bfc" id="L298" title="All 2 branches covered.">        final String path = PROPERTY_TYPES.contains(event.getType()) ?</span>
<span class="fc" id="L299">            event.getPath().substring(0, event.getPath().lastIndexOf(&quot;/&quot;)) : event.getPath();</span>

        // reformat any hash URIs and remove any trailing /jcr:content
<span class="fc" id="L302">        final HashConverter converter = new HashConverter();</span>
<span class="fc" id="L303">        return converter.reverse().convert(path.replaceAll(&quot;/&quot; + JCR_CONTENT, &quot;&quot;));</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>