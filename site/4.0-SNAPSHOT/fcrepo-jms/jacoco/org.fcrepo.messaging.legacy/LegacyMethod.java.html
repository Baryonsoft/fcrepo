<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>LegacyMethod.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">fcrepo-jms</a> &gt; <a href="index.html" class="el_package">org.fcrepo.messaging.legacy</a> &gt; <span class="el_source">LegacyMethod.java</span></div><h1>LegacyMethod.java</h1><pre class="source lang-java linenums">/**
 * Copyright 2013 DuraSpace, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.fcrepo.messaging.legacy;

import static com.google.common.base.Throwables.propagate;
import static javax.jcr.observation.Event.NODE_ADDED;
import static javax.jcr.observation.Event.NODE_REMOVED;
import static javax.jcr.observation.Event.PROPERTY_ADDED;
import static javax.jcr.observation.Event.PROPERTY_CHANGED;
import static javax.jcr.observation.Event.PROPERTY_REMOVED;
import static org.fcrepo.utils.FedoraTypesUtils.convertDateToXSDString;
import static org.slf4j.LoggerFactory.getLogger;

import java.io.IOException;
import java.io.InputStream;
import java.io.StringReader;
import java.io.Writer;
import java.util.Arrays;
import java.util.Date;
import java.util.List;
import java.util.Properties;

import javax.jcr.Node;
import javax.jcr.RepositoryException;
import javax.jcr.observation.Event;
import javax.jms.JMSException;
import javax.jms.Message;

import org.apache.abdera.model.Category;
import org.apache.abdera.model.Entry;
import org.fcrepo.utils.FedoraTypesUtils;
import org.slf4j.Logger;

public class LegacyMethod {

    // TODO Figure out where to get the base url
    private static final String BASE_URL = &quot;http://localhost:8080/rest&quot;;

<span class="fc" id="L53">    private static final Properties FEDORA_TYPES = new Properties();</span>

    public static final String FEDORA_ID_SCHEME = &quot;xsd:string&quot;;

    public static final String DSID_CATEGORY_LABEL = &quot;fedora-types:dsID&quot;;

    public static final String PID_CATEGORY_LABEL = &quot;fedora-types:pid&quot;;

    private static final String INGEST_METHOD = &quot;ingest&quot;;

    private static final String MODIFY_OBJ_METHOD = &quot;modifyObject&quot;;

    private static final String PURGE_OBJ_METHOD = &quot;purgeObject&quot;;

    private static final String ADD_DS_METHOD = &quot;addDatastream&quot;;

    private static final String MODIFY_DS_METHOD = &quot;modifyDatastream&quot;;

    private static final String PURGE_DS_METHOD = &quot;purgeDatastream&quot;;

<span class="fc" id="L73">    private static final String[] METHODS = new String[] {INGEST_METHOD,</span>
            MODIFY_OBJ_METHOD, PURGE_OBJ_METHOD, ADD_DS_METHOD,
            MODIFY_DS_METHOD, PURGE_DS_METHOD};

<span class="fc" id="L77">    private static final List&lt;String&gt; METHOD_NAMES = Arrays.asList(METHODS);</span>

<span class="fc" id="L79">    private static final Logger LOGGER = getLogger(LegacyMethod.class);</span>

    private static final String MAP_PROPERTIES =
            &quot;/org/fcrepo/messaging/legacy/map.properties&quot;;

    static {
<span class="pc" id="L85">        try (final InputStream is =</span>
                LegacyMethod.class.getResourceAsStream(MAP_PROPERTIES)) {
<span class="fc" id="L87">            FEDORA_TYPES.load(is);</span>
<span class="pc bpc" id="L88" title="6 of 8 branches missed.">        } catch (final IOException e) {</span>
            // it's in the jar.s
<span class="nc" id="L90">            throw propagate(e);</span>
<span class="fc" id="L91">        }</span>
<span class="fc" id="L92">    }</span>

    private final Entry delegate;

    public LegacyMethod(final Event jcrEvent, final Node resource)
            throws RepositoryException {
<span class="fc" id="L98">        this(EntryFactory.newEntry());</span>

<span class="fc" id="L100">        final boolean isDatastreamNode =</span>
                FedoraTypesUtils.isFedoraDatastream.apply(resource);
<span class="pc bpc" id="L102" title="1 of 4 branches missed.">        final boolean isObjectNode =</span>
                FedoraTypesUtils.isFedoraObject.apply(resource) &amp;&amp;
                        !isDatastreamNode;

<span class="pc bpc" id="L106" title="1 of 4 branches missed.">        if (isDatastreamNode || isObjectNode) {</span>
<span class="fc" id="L107">            setMethodName(mapMethodName(jcrEvent.getType(), isObjectNode));</span>
<span class="fc" id="L108">            final String returnValue = getReturnValue(jcrEvent, resource);</span>
<span class="fc" id="L109">            setContent(getEntryContent(getMethodName(), returnValue));</span>
<span class="fc bfc" id="L110" title="All 2 branches covered.">            if (isDatastreamNode) {</span>
<span class="fc" id="L111">                setPid(resource.getParent().getName());</span>
<span class="fc" id="L112">                setDsId(resource.getName());</span>
            } else {
<span class="fc" id="L114">                setPid(resource.getName());</span>
            }
<span class="fc" id="L116">        } else {</span>
<span class="nc" id="L117">            setMethodName(null);</span>
        }
<span class="pc bpc" id="L119" title="1 of 2 branches missed.">        final String userID =</span>
                jcrEvent.getUserID() == null ? &quot;unknown&quot; : jcrEvent.getUserID();
<span class="fc" id="L121">        setUserId(userID);</span>
<span class="fc" id="L122">        setModified(new Date(jcrEvent.getDate()));</span>
<span class="fc" id="L123">    }</span>

<span class="fc" id="L125">    public LegacyMethod(final Entry atomEntry) {</span>
<span class="fc" id="L126">        delegate = atomEntry;</span>
<span class="fc" id="L127">    }</span>

<span class="nc" id="L129">    public LegacyMethod(final String atomEntry) {</span>
<span class="nc" id="L130">        delegate = EntryFactory.parse(new StringReader(atomEntry));</span>
<span class="nc" id="L131">    }</span>

    public Entry getEntry() {
<span class="fc" id="L134">        return delegate;</span>
    }

    public void setContent(final String content) {
<span class="fc" id="L138">        delegate.setContent(content);</span>
<span class="fc" id="L139">    }</span>

    public void setUserId(String val) {
<span class="fc bfc" id="L142" title="All 2 branches covered.">        if (val == null) {</span>
<span class="fc" id="L143">            delegate.addAuthor(&quot;unknown&quot;, null, BASE_URL);</span>
        } else {
<span class="fc" id="L145">            delegate.addAuthor(val, null, BASE_URL);</span>
        }
<span class="fc" id="L147">    }</span>

    public String getUserID() {
<span class="fc" id="L150">        return delegate.getAuthor().getName();</span>
    }

    public void setModified(final Date date) {
<span class="fc" id="L154">        delegate.setUpdated(date);</span>
<span class="fc" id="L155">    }</span>

    public Date getModified() {
<span class="fc" id="L158">        return delegate.getUpdated();</span>
    }

    public void setMethodName(final String val) {
<span class="fc" id="L162">        delegate.setTitle(val).setBaseUri(BASE_URL);</span>
<span class="fc" id="L163">    }</span>

    public String getMethodName() {
<span class="fc" id="L166">        return delegate.getTitle();</span>
    }

    private void setLabelledCategory(String label, String val) {
<span class="fc" id="L170">        final List&lt;Category&gt; vals = delegate.getCategories(FEDORA_ID_SCHEME);</span>
<span class="fc" id="L171">        Category found = null;</span>
<span class="pc bpc" id="L172" title="1 of 4 branches missed.">        if (vals != null &amp;&amp; !vals.isEmpty()) {</span>
<span class="fc bfc" id="L173" title="All 2 branches covered.">            for (Category c : vals) {</span>
<span class="fc bfc" id="L174" title="All 2 branches covered.">                if (label.equals(c.getLabel())) {</span>
<span class="fc" id="L175">                    found = c.setTerm(val);</span>
                }
<span class="fc" id="L177">            }</span>
        }
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">        if (found == null) {</span>
<span class="fc" id="L180">            delegate.addCategory(FEDORA_ID_SCHEME, val, label);</span>
        }
<span class="fc" id="L182">    }</span>

    private String getLabelledCategory(String label) {
<span class="fc" id="L185">        final List&lt;Category&gt; categories =</span>
                delegate.getCategories(FEDORA_ID_SCHEME);
<span class="pc bpc" id="L187" title="1 of 2 branches missed.">        for (final Category c : categories) {</span>
<span class="fc bfc" id="L188" title="All 2 branches covered.">            if (label.equals(c.getLabel())) {</span>
<span class="fc" id="L189">                return c.getTerm();</span>
            }
<span class="fc" id="L191">        }</span>
<span class="nc" id="L192">        return null;</span>
    }

    public void setPid(final String val) {
<span class="fc" id="L196">        setLabelledCategory(PID_CATEGORY_LABEL, val);</span>
<span class="fc" id="L197">        delegate.setSummary(val);</span>
<span class="fc" id="L198">    }</span>

    public String getPid() {
<span class="fc" id="L201">        return getLabelledCategory(PID_CATEGORY_LABEL);</span>
    }

    public void setDsId(final String val) {
<span class="fc" id="L205">        setLabelledCategory(DSID_CATEGORY_LABEL, val);</span>
<span class="fc" id="L206">    }</span>

    public String getDsId() {
<span class="fc" id="L209">        return getLabelledCategory(DSID_CATEGORY_LABEL);</span>
    }

    public void writeTo(final Writer writer) throws IOException {
<span class="fc" id="L213">        delegate.writeTo(writer);</span>
<span class="fc" id="L214">    }</span>

    private static String getEntryContent(final String methodName,
            final String returnVal) {
<span class="fc" id="L218">        final String datatype =</span>
                (String) FEDORA_TYPES.get(methodName + &quot;.datatype&quot;);
<span class="fc" id="L220">        return objectToString(returnVal, datatype);</span>
    }

    protected static String objectToString(final String obj,
            final String xsdType) {
<span class="fc bfc" id="L225" title="All 2 branches covered.">        if (obj == null) {</span>
<span class="fc" id="L226">            return &quot;null&quot;;</span>
        }
        String term;
        // TODO Most of these types are not yet relevant to FCR4, but we can
        // borrow their serializations as necessary
        // several circumstances yield null canonical names
<span class="pc bpc" id="L232" title="4 of 18 branches missed.">        switch (xsdType) {</span>
            case &quot;fedora-types:ArrayOfString&quot;:
<span class="fc" id="L234">                term = &quot;[UNSUPPORTED&quot; + xsdType + &quot;]&quot;;</span>
<span class="fc" id="L235">                break;</span>
            case &quot;xsd:boolean&quot;:
<span class="fc" id="L237">                term = obj;</span>
<span class="fc" id="L238">                break;</span>
            case &quot;xsd:nonNegativeInteger&quot;:
<span class="fc" id="L240">                term = obj;</span>
<span class="fc" id="L241">                break;</span>
            case &quot;fedora-types:RelationshipTuple&quot;:
<span class="fc" id="L243">                term = &quot;[UNSUPPORTED&quot; + xsdType + &quot;]&quot;;</span>
<span class="fc" id="L244">                break;</span>
            default:
<span class="fc" id="L246">                term = obj;</span>
<span class="fc" id="L247">                term = term.replaceAll(&quot;\&quot;&quot;, &quot;'&quot;);</span>
                break;
        }

<span class="fc" id="L251">        return term;</span>
    }

    protected static String getReturnValue(final Event jcrEvent,
            final Node jcrNode) throws RepositoryException {
<span class="fc bfc" id="L256" title="All 3 branches covered.">        switch (jcrEvent.getType()) {</span>
            case NODE_ADDED:
<span class="fc" id="L258">                return jcrNode.getName();</span>
            case NODE_REMOVED:
            case PROPERTY_ADDED:
            case PROPERTY_CHANGED:
            case PROPERTY_REMOVED:
<span class="fc" id="L263">                return convertDateToXSDString(jcrEvent.getDate());</span>
            default:
<span class="fc" id="L265">                return null;</span>
        }
    }

    protected static String mapMethodName(final int eventType,
            final boolean isObjectNode) {
<span class="pc bpc" id="L271" title="4 of 6 branches missed.">        switch (eventType) {</span>
            case NODE_ADDED:
<span class="pc bpc" id="L273" title="1 of 2 branches missed.">                return isObjectNode ? INGEST_METHOD : ADD_DS_METHOD;</span>
            case NODE_REMOVED:
<span class="nc bnc" id="L275" title="All 2 branches missed.">                return isObjectNode ? PURGE_OBJ_METHOD : PURGE_DS_METHOD;</span>
            case PROPERTY_ADDED:
<span class="nc bnc" id="L277" title="All 2 branches missed.">                return isObjectNode ? MODIFY_OBJ_METHOD : MODIFY_DS_METHOD;</span>
            case PROPERTY_CHANGED:
<span class="nc bnc" id="L279" title="All 2 branches missed.">                return isObjectNode ? MODIFY_OBJ_METHOD : MODIFY_DS_METHOD;</span>
            case PROPERTY_REMOVED:
<span class="nc bnc" id="L281" title="All 2 branches missed.">                return isObjectNode ? MODIFY_OBJ_METHOD : MODIFY_DS_METHOD;</span>
        }
<span class="fc" id="L283">        return null;</span>
    }

    public static boolean canParse(final Message jmsMessage) {
        try {
<span class="fc bfc" id="L288" title="All 4 branches covered.">            return EntryFactory.FORMAT.equals(jmsMessage.getJMSType()) &amp;&amp;</span>
                    METHOD_NAMES.contains(jmsMessage
                            .getStringProperty(&quot;methodName&quot;));
<span class="nc" id="L291">        } catch (final JMSException e) {</span>
<span class="nc" id="L292">            LOGGER.info(&quot;Could not parse message: {}&quot;, jmsMessage);</span>
<span class="nc" id="L293">            throw propagate(e);</span>
        }
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.3.201306030806</span></div></body></html>