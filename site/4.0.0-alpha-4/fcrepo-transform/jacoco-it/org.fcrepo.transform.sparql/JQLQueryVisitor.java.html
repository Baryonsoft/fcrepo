<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>JQLQueryVisitor.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Fedora Repository RDF Transformations Module</a> &gt; <a href="index.source.html" class="el_package">org.fcrepo.transform.sparql</a> &gt; <span class="el_source">JQLQueryVisitor.java</span></div><h1>JQLQueryVisitor.java</h1><pre class="source lang-java linenums">/**
 * Copyright 2013 DuraSpace, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.fcrepo.transform.sparql;

import com.google.common.collect.ImmutableList;
import com.google.common.collect.ImmutableSet;
import com.google.common.collect.Sets;
import com.hp.hpl.jena.graph.Node;
import com.hp.hpl.jena.graph.Triple;
import com.hp.hpl.jena.query.Query;
import com.hp.hpl.jena.query.QueryVisitor;
import com.hp.hpl.jena.query.SortCondition;
import com.hp.hpl.jena.rdf.model.Model;
import com.hp.hpl.jena.sparql.core.Prologue;
import com.hp.hpl.jena.sparql.core.TriplePath;
import com.hp.hpl.jena.sparql.expr.Expr;
import com.hp.hpl.jena.sparql.expr.ExprAggregator;
import com.hp.hpl.jena.sparql.expr.ExprFunction0;
import com.hp.hpl.jena.sparql.expr.ExprFunction1;
import com.hp.hpl.jena.sparql.expr.ExprFunction2;
import com.hp.hpl.jena.sparql.expr.ExprFunction3;
import com.hp.hpl.jena.sparql.expr.ExprFunctionN;
import com.hp.hpl.jena.sparql.expr.ExprFunctionOp;
import com.hp.hpl.jena.sparql.expr.ExprVar;
import com.hp.hpl.jena.sparql.expr.ExprVisitor;
import com.hp.hpl.jena.sparql.expr.FunctionLabel;
import com.hp.hpl.jena.sparql.expr.NodeValue;
import com.hp.hpl.jena.sparql.syntax.Element;
import com.hp.hpl.jena.sparql.syntax.ElementAssign;
import com.hp.hpl.jena.sparql.syntax.ElementBind;
import com.hp.hpl.jena.sparql.syntax.ElementData;
import com.hp.hpl.jena.sparql.syntax.ElementDataset;
import com.hp.hpl.jena.sparql.syntax.ElementExists;
import com.hp.hpl.jena.sparql.syntax.ElementFilter;
import com.hp.hpl.jena.sparql.syntax.ElementGroup;
import com.hp.hpl.jena.sparql.syntax.ElementMinus;
import com.hp.hpl.jena.sparql.syntax.ElementNamedGraph;
import com.hp.hpl.jena.sparql.syntax.ElementNotExists;
import com.hp.hpl.jena.sparql.syntax.ElementOptional;
import com.hp.hpl.jena.sparql.syntax.ElementPathBlock;
import com.hp.hpl.jena.sparql.syntax.ElementService;
import com.hp.hpl.jena.sparql.syntax.ElementSubQuery;
import com.hp.hpl.jena.sparql.syntax.ElementTriplesBlock;
import com.hp.hpl.jena.sparql.syntax.ElementUnion;
import com.hp.hpl.jena.sparql.syntax.ElementVisitor;

import org.apache.commons.lang.NotImplementedException;
import org.fcrepo.kernel.rdf.JcrRdfTools;
import org.fcrepo.transform.exception.JQLParsingException;
import org.modeshape.common.collection.Collections;
import org.modeshape.jcr.api.query.qom.Limit;
import org.modeshape.jcr.api.query.qom.SelectQuery;
import org.slf4j.Logger;

import javax.jcr.RepositoryException;
import javax.jcr.Session;
import javax.jcr.Value;
import javax.jcr.query.QueryManager;
import javax.jcr.query.qom.Column;
import javax.jcr.query.qom.Constraint;
import javax.jcr.query.qom.JoinCondition;
import javax.jcr.query.qom.Literal;
import javax.jcr.query.qom.Ordering;
import javax.jcr.query.qom.PropertyValue;
import javax.jcr.query.qom.QueryObjectModel;
import javax.jcr.query.qom.QueryObjectModelFactory;
import javax.jcr.query.qom.Source;

import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;

import static com.google.common.base.Throwables.propagate;
import static com.google.common.collect.Sets.difference;
import static com.google.common.primitives.Ints.checkedCast;
import static com.hp.hpl.jena.query.Query.ORDER_DESCENDING;
import static com.hp.hpl.jena.rdf.model.ModelFactory.createDefaultModel;
import static java.lang.Integer.MAX_VALUE;
import static javax.jcr.PropertyType.REFERENCE;
import static javax.jcr.PropertyType.URI;
import static javax.jcr.PropertyType.WEAKREFERENCE;
import static javax.jcr.query.qom.QueryObjectModelConstants.JCR_JOIN_TYPE_INNER;
import static javax.jcr.query.qom.QueryObjectModelConstants.JCR_JOIN_TYPE_LEFT_OUTER;
import static javax.jcr.query.qom.QueryObjectModelConstants.JCR_OPERATOR_EQUAL_TO;
import static javax.jcr.query.qom.QueryObjectModelConstants.JCR_OPERATOR_GREATER_THAN;
import static javax.jcr.query.qom.QueryObjectModelConstants.JCR_OPERATOR_GREATER_THAN_OR_EQUAL_TO;
import static javax.jcr.query.qom.QueryObjectModelConstants.JCR_OPERATOR_LESS_THAN;
import static javax.jcr.query.qom.QueryObjectModelConstants.JCR_OPERATOR_LESS_THAN_OR_EQUAL_TO;
import static javax.jcr.query.qom.QueryObjectModelConstants.JCR_OPERATOR_LIKE;
import static javax.jcr.query.qom.QueryObjectModelConstants.JCR_OPERATOR_NOT_EQUAL_TO;
import static org.fcrepo.jcr.FedoraJcrTypes.FEDORA_RESOURCE;
import static org.fcrepo.kernel.utils.NodePropertiesTools.getReferencePropertyName;
import static org.modeshape.jcr.api.JcrConstants.JCR_PATH;
import static org.slf4j.LoggerFactory.getLogger;

/**
 * Implements the Jena QueryVisitor pattern to translate a SPARQL query into
 * a JCR query
 *
 * @author cabeer
 */
public class JQLQueryVisitor implements QueryVisitor, ElementVisitor, ExprVisitor {

<span class="fc" id="L120">    private static final Logger LOGGER = getLogger(JQLQueryVisitor.class);</span>

    private QueryObjectModelFactory queryFactory;
    private Source source;
    private ImmutableSet.Builder&lt;Column&gt; columns;
    private ImmutableList.Builder&lt;Ordering&gt;  orderings;
    private Constraint constraint;
<span class="fc" id="L127">    private boolean hasLimit = false;</span>
    private long offset;
    private long limit;
    private Session session;
    private JcrRdfTools jcrTools;
    private Set&lt;String&gt; resultsVars;
    private Map&lt;String, Column&gt; variables;
    private boolean distinct;
    private boolean inOptional;
    private Map&lt;String, Source&gt; joins;
    private Map&lt;String, String&gt; joinTypes;
    private Map&lt;String, JoinCondition&gt; joinConditions;

    /**
     * Create a new query
     * @param session
     * @param jcrTools
     * @param queryManager
     */
    public JQLQueryVisitor(final Session session,
                           final JcrRdfTools jcrTools,
<span class="fc" id="L148">                           final QueryManager queryManager) {</span>
<span class="fc" id="L149">        this.session = session;</span>
<span class="fc" id="L150">        this.jcrTools = jcrTools;</span>
<span class="fc" id="L151">        this.queryFactory = queryManager.getQOMFactory();</span>
<span class="fc" id="L152">        this.constraint = null;</span>
<span class="fc" id="L153">        this.variables = new HashMap&lt;&gt;();</span>
<span class="fc" id="L154">        this.joins = new HashMap&lt;&gt;();</span>
<span class="fc" id="L155">        this.joinTypes = new HashMap&lt;&gt;();</span>
<span class="fc" id="L156">        this.joinConditions = new HashMap&lt;&gt;();</span>
<span class="fc" id="L157">    }</span>

    /**
     * Create a subquery, using the same variables, joins, etc, but without existing constraints
     *
     * @param jqlQueryVisitor
     */
<span class="fc" id="L164">    public JQLQueryVisitor(final JQLQueryVisitor jqlQueryVisitor) {</span>
<span class="fc" id="L165">        this.session = jqlQueryVisitor.session;</span>
<span class="fc" id="L166">        this.jcrTools = jqlQueryVisitor.jcrTools;</span>
<span class="fc" id="L167">        this.queryFactory = jqlQueryVisitor.queryFactory;</span>
<span class="fc" id="L168">        this.constraint = null;</span>
<span class="fc" id="L169">        this.variables = jqlQueryVisitor.variables;</span>
<span class="fc" id="L170">        this.joins = jqlQueryVisitor.joins;</span>
<span class="fc" id="L171">        this.joinConditions = jqlQueryVisitor.joinConditions;</span>
<span class="fc" id="L172">    }</span>

    /**
     * Get the raw JCR query
     * @return
     * @throws RepositoryException
     */
    public QueryObjectModel getQuery() throws RepositoryException {
<span class="fc" id="L180">        final org.modeshape.jcr.api.query.qom.QueryObjectModelFactory modeQueryFactory =</span>
            (org.modeshape.jcr.api.query.qom.QueryObjectModelFactory)queryFactory;
        final int actualLimit;

<span class="fc bfc" id="L184" title="All 2 branches covered.">        if (this.hasLimit) {</span>
<span class="fc" id="L185">            actualLimit = checkedCast(this.limit);</span>
        } else {
<span class="fc" id="L187">            actualLimit = MAX_VALUE;</span>
        }

<span class="fc" id="L190">        final Limit selectLimit = modeQueryFactory.limit(actualLimit, checkedCast(this.offset));</span>
<span class="fc" id="L191">        final SelectQuery query = modeQueryFactory.select(getSource(),</span>
                                                             getConstraint(),
                                                             getOrderings(),
                                                             getColumns(),
                                                             selectLimit,
                                                             distinct);


<span class="fc" id="L199">        return modeQueryFactory.createQuery(query);</span>
    }

    /**
     * Get the JCR query source information
     * @return
     */
    private Source getSource() {
<span class="fc" id="L207">        final Sets.SetView&lt;String&gt; difference = difference(joins.keySet(), joinConditions.keySet());</span>

        final Source parentSource;

<span class="fc" id="L211">        final Iterator&lt;String&gt; unmatchedJoins = difference.iterator();</span>

<span class="pc bpc" id="L213" title="1 of 2 branches missed.">        if (unmatchedJoins.hasNext()) {</span>
<span class="fc" id="L214">            parentSource = joins.get(unmatchedJoins.next());</span>
<span class="fc" id="L215">            this.source = parentSource;</span>
        } else {
<span class="nc" id="L217">            throw new JQLParsingException(&quot;No primary source column found in query&quot;);</span>
        }

        try {
<span class="fc bfc" id="L221" title="All 2 branches covered.">            for (final Map.Entry&lt;String, Source&gt; entry : joins.entrySet()) {</span>

<span class="fc bfc" id="L223" title="All 2 branches covered.">                if (entry.getValue() != parentSource) {</span>
                    final String joinType;

<span class="fc bfc" id="L226" title="All 2 branches covered.">                    if (joinTypes.containsKey(entry.getKey())) {</span>
<span class="fc" id="L227">                        joinType = JCR_JOIN_TYPE_INNER;</span>
                    } else {
<span class="fc" id="L229">                        joinType = JCR_JOIN_TYPE_LEFT_OUTER;</span>
                    }

<span class="fc" id="L232">                    this.source =</span>
                        queryFactory.join(this.source, entry.getValue(),
                                joinType, joinConditions.get(entry.getKey()));
                }
<span class="fc" id="L236">            }</span>

<span class="nc" id="L238">        } catch (final RepositoryException e) {</span>
<span class="nc" id="L239">            LOGGER.info(&quot;Repository exception building query source&quot;, e);</span>
<span class="fc" id="L240">        }</span>
<span class="fc" id="L241">        return this.source;</span>
    }

    /**
     * Get the columns for the JCR query
     * @return
     */
    private Column[] getColumns() {
<span class="fc" id="L249">        final ImmutableSet&lt;Column&gt; build = this.columns.build();</span>
<span class="fc" id="L250">        return build.toArray(new Column[build.size()]);</span>
    }

    /**
     * Get the ordering of the JCR query
     * @return
     */
    private Ordering[] getOrderings() {
<span class="fc" id="L258">        final ImmutableList&lt;Ordering&gt; build = this.orderings.build();</span>
<span class="fc" id="L259">        return build.toArray(new Ordering[build.size()]);</span>
    }

    /**
     * Get the constraints imposed on the JCR query
     * @return
     */
    private Constraint getConstraint() {
<span class="fc" id="L267">        return this.constraint;</span>
    }

    @Override
    public void startVisit(final Query query) {
<span class="fc" id="L272">        LOGGER.trace(&quot;START VISIT: {}&quot;, query);</span>
<span class="fc" id="L273">        this.columns = new ImmutableSet.Builder&lt;&gt;();</span>
<span class="fc" id="L274">        this.orderings = new ImmutableList.Builder&lt;&gt;();</span>
<span class="fc" id="L275">    }</span>

    @Override
    public void visitPrologue(final Prologue prologue) {
<span class="fc" id="L279">        LOGGER.trace(&quot;VISIT PROLOGUE: {}&quot;, prologue);</span>
<span class="fc" id="L280">    }</span>

    @Override
    public void visitResultForm(final Query query) {
<span class="fc" id="L284">        LOGGER.trace(&quot;VISIT RESULT FORM: {}&quot;, query);</span>
<span class="fc" id="L285">    }</span>

    @Override
    public void visitSelectResultForm(final Query query) {
<span class="fc" id="L289">        LOGGER.trace(&quot;VISIT SELECT RESULT FORM: {}&quot;, query.getResultVars());</span>
<span class="fc" id="L290">        resultsVars = Collections.unmodifiableSet(query.getResultVars());</span>

<span class="fc" id="L292">        this.distinct = query.isDistinct();</span>
<span class="fc" id="L293">    }</span>

    @Override
    public void visitConstructResultForm(final Query query) {
<span class="nc" id="L297">        LOGGER.trace(&quot;VISIT CONSTRUCT RESULT FORM: {}&quot;, query);</span>
<span class="nc" id="L298">    }</span>

    @Override
    public void visitDescribeResultForm(final Query query) {
<span class="nc" id="L302">        LOGGER.trace(&quot;VISIT DESCRIBE RESULT FORM: {}&quot;, query);</span>
<span class="nc" id="L303">    }</span>

    @Override
    public void visitAskResultForm(final Query query) {
<span class="nc" id="L307">        LOGGER.trace(&quot;VISIT ASK RESULT FORM: {}&quot;, query);</span>
<span class="nc" id="L308">    }</span>

    @Override
    public void visitDatasetDecl(final Query query) {
<span class="pc bpc" id="L312" title="1 of 2 branches missed.">        if (query.hasDatasetDescription()) {</span>
<span class="nc" id="L313">            LOGGER.trace(&quot;VISIT DATASET DESC FORM: {}&quot;, query.getDatasetDescription());</span>
        }
<span class="fc" id="L315">    }</span>

    @Override
    public void visitQueryPattern(final Query query) {
<span class="fc" id="L319">        LOGGER.trace(&quot;VISIT QUERY PATTERN: {}&quot;, query.getQueryPattern());</span>
<span class="fc" id="L320">        final Element queryPattern = query.getQueryPattern();</span>
<span class="fc" id="L321">        queryPattern.visit(this);</span>
<span class="fc" id="L322">    }</span>

    @Override
    public void visitGroupBy(final Query query) {
<span class="pc bpc" id="L326" title="1 of 2 branches missed.">        if (query.hasGroupBy()) {</span>
<span class="nc" id="L327">            LOGGER.trace(&quot;VISIT GROUP BY: {}&quot;, query.getGroupBy());</span>
<span class="nc" id="L328">            throw new NotImplementedException(&quot;GROUP BY&quot;);</span>
        }
<span class="fc" id="L330">    }</span>

    @Override
    public void visitHaving(final Query query) {
<span class="pc bpc" id="L334" title="1 of 2 branches missed.">        if (query.hasHaving()) {</span>
<span class="nc" id="L335">            LOGGER.trace(&quot;VISIT HAVING: {}&quot;, query.getHavingExprs());</span>
<span class="nc" id="L336">            throw new NotImplementedException(&quot;HAVING&quot;);</span>
        }
<span class="fc" id="L338">    }</span>

    @Override
    public void visitOrderBy(final Query query) {
<span class="fc bfc" id="L342" title="All 2 branches covered.">        if (query.hasOrderBy()) {</span>
<span class="fc" id="L343">            LOGGER.trace(&quot;VISIT ORDER BY: {}&quot;, query.getOrderBy());</span>
            try {
<span class="fc bfc" id="L345" title="All 2 branches covered.">                for (final SortCondition sortCondition : query.getOrderBy()) {</span>

                    final PropertyValue property;
<span class="fc" id="L348">                    final Expr expression = sortCondition.getExpression();</span>

<span class="pc bpc" id="L350" title="1 of 2 branches missed.">                    if (expression.isConstant()) {</span>
<span class="nc" id="L351">                        property = queryFactory.propertyValue(FEDORA_RESOURCE, expression.getConstant().asString());</span>
<span class="pc bpc" id="L352" title="1 of 2 branches missed.">                    } else if (expression.isVariable()) {</span>
<span class="fc" id="L353">                        final Column c = variables.get(expression.getVarName());</span>

<span class="fc" id="L355">                        property = queryFactory.propertyValue(c.getSelectorName(), c.getPropertyName());</span>
<span class="fc" id="L356">                    } else {</span>
<span class="nc" id="L357">                        property = null;</span>
                    }

<span class="pc bpc" id="L360" title="1 of 2 branches missed.">                    if (property != null) {</span>
                        final Ordering ordering;

<span class="fc bfc" id="L363" title="All 2 branches covered.">                        if (sortCondition.getDirection() == ORDER_DESCENDING) {</span>
<span class="fc" id="L364">                            ordering = queryFactory.descending(property);</span>
                        } else {
<span class="fc" id="L366">                            ordering = queryFactory.ascending(property);</span>

                        }

<span class="fc" id="L370">                        this.orderings.add(ordering);</span>
<span class="fc" id="L371">                    } else {</span>
<span class="nc" id="L372">                        LOGGER.debug(&quot;IGNORING UNKNOWN ORDER CONDITION {}&quot;, sortCondition);</span>
                    }
<span class="fc" id="L374">                }</span>

<span class="nc" id="L376">            } catch (final RepositoryException e) {</span>
<span class="nc" id="L377">                throw propagate(e);</span>
<span class="fc" id="L378">            }</span>
        }
<span class="fc" id="L380">    }</span>

    @Override
    public void visitLimit(final Query query) {
<span class="fc bfc" id="L384" title="All 2 branches covered.">        if (query.hasLimit()) {</span>
<span class="fc" id="L385">            LOGGER.trace(&quot;VISIT LIMIT: {}&quot;, query.getLimit());</span>
<span class="fc" id="L386">            this.hasLimit = true;</span>
<span class="fc" id="L387">            this.limit = query.getLimit();</span>
        }
<span class="fc" id="L389">    }</span>

    @Override
    public void visitOffset(final Query query) {
<span class="fc bfc" id="L393" title="All 2 branches covered.">        if (query.hasOffset()) {</span>
<span class="fc" id="L394">            LOGGER.trace(&quot;VISIT OFFSET: {}&quot;, query.getOffset());</span>
<span class="fc" id="L395">            this.offset = query.getOffset();</span>
        }
<span class="fc" id="L397">    }</span>

    @Override
    public void visitValues(final Query query) {
<span class="pc bpc" id="L401" title="1 of 2 branches missed.">        if (query.hasValues()) {</span>
<span class="nc" id="L402">            LOGGER.trace(&quot;VISIT VALUES: {}&quot;, query.getValuesData());</span>
<span class="nc" id="L403">            throw new NotImplementedException(&quot;VALUES&quot;);</span>
        }
<span class="fc" id="L405">    }</span>

    @Override
    public void finishVisit(final Query query) {
<span class="fc" id="L409">        LOGGER.trace(&quot;FINISH VISIT: {}&quot;, query);</span>
<span class="fc" id="L410">    }</span>

    @Override
    public void visit(final ElementTriplesBlock el) {
<span class="nc" id="L414">        LOGGER.trace(&quot;VISIT TRIPLES: {}&quot;, el);</span>
<span class="nc" id="L415">        final Iterator&lt;Triple&gt; tripleIterator = el.patternElts();</span>

<span class="nc bnc" id="L417" title="All 2 branches missed.">        while (tripleIterator.hasNext()) {</span>
<span class="nc" id="L418">            final Triple next = tripleIterator.next();</span>
<span class="nc" id="L419">            next.getObject();</span>
<span class="nc" id="L420">        }</span>
<span class="nc" id="L421">    }</span>

    @Override
    public void visit(final ElementPathBlock el) {
<span class="fc" id="L425">        LOGGER.trace(&quot;VISIT PATH BLOCK: {}&quot;, el);</span>
<span class="fc" id="L426">        Iterator&lt;TriplePath&gt; triplePathIterator = el.patternElts();</span>


        try {
<span class="fc bfc" id="L430" title="All 2 branches covered.">            while (triplePathIterator.hasNext()) {</span>
<span class="fc" id="L431">                final TriplePath next = triplePathIterator.next();</span>
<span class="fc" id="L432">                final Node subject = next.getSubject();</span>

<span class="pc bpc" id="L434" title="1 of 2 branches missed.">                if (subject.isVariable()) {</span>
<span class="fc" id="L435">                    final String selectorName =</span>
                        &quot;fedoraResource_&quot; + subject.getName();

<span class="fc" id="L438">                    this.joins.put(subject.getName(), queryFactory.selector(</span>
                            FEDORA_RESOURCE, selectorName));

<span class="fc" id="L441">                    final Column c =</span>
                        queryFactory.column(selectorName, JCR_PATH, subject
                                .getName());
<span class="fc" id="L444">                    variables.put(subject.getName(), c);</span>
                }
<span class="fc" id="L446">            }</span>

<span class="fc" id="L448">            triplePathIterator = el.patternElts();</span>

<span class="fc bfc" id="L450" title="All 2 branches covered.">            while (triplePathIterator.hasNext()) {</span>
<span class="fc" id="L451">                final TriplePath next = triplePathIterator.next();</span>
<span class="fc" id="L452">                LOGGER.trace(&quot; - TRIPLE PATH: {}&quot;, next);</span>

<span class="fc" id="L454">                final Node subject = next.getSubject();</span>
<span class="fc" id="L455">                final Node predicate = next.getPredicate();</span>
<span class="fc" id="L456">                final Node object = next.getObject();</span>
<span class="fc" id="L457">                final Model defaultModel = createDefaultModel();</span>

<span class="pc bpc" id="L459" title="1 of 2 branches missed.">                if (subject.isVariable()) {</span>
<span class="fc" id="L460">                    final Column c = variables.get(subject.getName());</span>

<span class="fc bfc" id="L462" title="All 2 branches covered.">                    if (resultsVars.contains(subject.getName())) {</span>
<span class="fc" id="L463">                        columns.add(c);</span>
                    }

<span class="pc bpc" id="L466" title="1 of 2 branches missed.">                    if (predicate.isVariable()) {</span>
<span class="nc" id="L467">                        throw new NotImplementedException(</span>
                                &quot;Element path may not contain a variable predicate&quot;);
                    }

<span class="fc" id="L471">                    final String propertyName =</span>
                        jcrTools.getPropertyNameFromPredicate(defaultModel
                                .createProperty(predicate.getURI()));

<span class="pc bpc" id="L475" title="1 of 4 branches missed.">                    if (propertyName.equals(&quot;rdf:type&quot;) &amp;&amp; object.isURI()) {</span>
<span class="fc" id="L476">                        final String mixinName =</span>
                            jcrTools.getPropertyNameFromPredicate(defaultModel
                                    .createProperty(object.getURI()));

<span class="fc bfc" id="L480" title="All 2 branches covered.">                        if (session.getWorkspace().getNodeTypeManager()</span>
                                .hasNodeType(mixinName)) {
<span class="fc" id="L482">                            final String selectorName =</span>
                                &quot;ref_type_&quot; + mixinName.replace(&quot;:&quot;, &quot;_&quot;);

<span class="fc" id="L485">                            this.joins.put(selectorName, queryFactory.selector(</span>
                                    mixinName, selectorName));

<span class="fc" id="L488">                            joinTypes.put(selectorName, JCR_JOIN_TYPE_INNER);</span>
<span class="fc" id="L489">                            joinConditions.put(selectorName, queryFactory</span>
                                    .sameNodeJoinCondition(c.getSelectorName(),
                                            selectorName, &quot;.&quot;));
<span class="fc" id="L492">                            continue;</span>
                        }
                    }

<span class="fc" id="L496">                    final int propertyType = jcrTools.getPropertyType(FEDORA_RESOURCE, propertyName);</span>

<span class="fc bfc" id="L498" title="All 2 branches covered.">                    if (object.isVariable()) {</span>

                        final Column objectColumn;

<span class="pc bpc" id="L502" title="2 of 8 branches missed.">                        if ((propertyType == REFERENCE || propertyType == WEAKREFERENCE || propertyType == URI)</span>
                                &amp;&amp; variables.containsKey(object.getName()))  {

<span class="fc" id="L505">                            objectColumn = variables.get(object.getName());</span>

                            final String joinPropertyName;

<span class="pc bpc" id="L509" title="1 of 2 branches missed.">                            if (propertyType == URI) {</span>
<span class="nc" id="L510">                                joinPropertyName = getReferencePropertyName(propertyName);</span>
                            } else {
<span class="fc" id="L512">                                joinPropertyName = propertyName;</span>
                            }

<span class="fc" id="L515">                            joinConditions.put(object.getName(),</span>
                                                  queryFactory.equiJoinCondition(
                                                      c.getSelectorName(), joinPropertyName,
                                                      objectColumn.getSelectorName(), &quot;jcr:uuid&quot;));
<span class="fc" id="L519">                        } else {</span>
<span class="fc" id="L520">                            objectColumn = queryFactory.column(c.getSelectorName(),</span>
                                                                  propertyName,
                                                                  object.getName());

<span class="fc" id="L524">                            variables.put(object.getName(), objectColumn);</span>

<span class="pc bpc" id="L526" title="1 of 2 branches missed.">                            if (resultsVars.contains(object.getName())) {</span>
<span class="fc" id="L527">                                columns.add(objectColumn);</span>
                            }
                        }

<span class="fc bfc" id="L531" title="All 2 branches covered.">                        if (!inOptional) {</span>
<span class="fc" id="L532">                            appendConstraint(queryFactory.propertyExistence(c.getSelectorName(), propertyName));</span>
                        }
<span class="fc" id="L534">                    } else {</span>

<span class="pc bpc" id="L536" title="1 of 2 branches missed.">                        if (!inOptional) {</span>
<span class="fc" id="L537">                            final PropertyValue field = queryFactory.propertyValue(c.getSelectorName(), propertyName);</span>
<span class="fc" id="L538">                            final Value jcrValue = jcrTools.createValue(defaultModel.asRDFNode(object), propertyType);</span>
<span class="fc" id="L539">                            final Literal literal = queryFactory.literal(jcrValue);</span>
<span class="fc" id="L540">                            appendConstraint(queryFactory.comparison(field, JCR_OPERATOR_EQUAL_TO, literal));</span>
                        }

                    }

<span class="pc bnc" id="L545" title="All 2 branches missed.">                } else if (predicate.isVariable()) {</span>
<span class="nc" id="L546">                    throw new NotImplementedException(&quot;Element path with constant subject and variable predicate&quot;);</span>

<span class="nc bnc" id="L548" title="All 2 branches missed.">                } else if (object.isVariable()) {</span>
<span class="nc" id="L549">                    throw new NotImplementedException(</span>
                            &quot;Element path with constant subject and predicate, and a variable object&quot;);

                } else {
<span class="nc" id="L553">                    throw new NotImplementedException(&quot;Element path with constant subject/predicate/object&quot;);</span>
                }

<span class="fc" id="L556">            }</span>
<span class="nc" id="L557">        } catch (final RepositoryException e) {</span>
<span class="nc" id="L558">            throw propagate(e);</span>
<span class="fc" id="L559">        }</span>
<span class="fc" id="L560">    }</span>

    @Override
    public void visit(final ElementFilter el) {
<span class="fc" id="L564">        LOGGER.trace(&quot;VISIT FILTER: {}&quot;, el);</span>
<span class="fc" id="L565">        el.getExpr().visit(this);</span>
<span class="fc" id="L566">    }</span>

    @Override
    public void visit(final ElementAssign el) {
<span class="nc" id="L570">        LOGGER.trace(&quot;VISIT ASSIGN: {}&quot;, el);</span>
<span class="nc" id="L571">        throw new NotImplementedException(&quot;ASSIGN&quot;);</span>
    }

    @Override
    public void visit(final ElementBind el) {
<span class="nc" id="L576">        LOGGER.trace(&quot;VISIT BIND: {}&quot;, el);</span>
<span class="nc" id="L577">        throw new NotImplementedException(&quot;BIND&quot;);</span>
    }

    @Override
    public void visit(final ElementData el) {
<span class="nc" id="L582">        LOGGER.trace(&quot;VISIT DATA: {}&quot;, el);</span>
<span class="nc" id="L583">        throw new NotImplementedException(&quot;DATA&quot;);</span>
    }

    @Override
    public void visit(final ElementUnion el) {
<span class="nc" id="L588">        LOGGER.trace(&quot;VISIT UNION: {}&quot;, el);</span>
<span class="nc" id="L589">        throw new NotImplementedException(&quot;UNION&quot;);</span>
    }

    @Override
    public void visit(final ElementOptional el) {
<span class="fc" id="L594">        LOGGER.trace(&quot;VISIT OPTIONAL: {}&quot;, el);</span>
<span class="fc" id="L595">        this.inOptional = true;</span>
<span class="fc" id="L596">        el.getOptionalElement().visit(this);</span>
<span class="fc" id="L597">        this.inOptional = false;</span>
<span class="fc" id="L598">    }</span>

    @Override
    public void visit(final ElementGroup el) {
<span class="fc" id="L602">        LOGGER.trace(&quot;VISIT GROUP: {}&quot;, el);</span>

<span class="fc bfc" id="L604" title="All 2 branches covered.">        for (final Element element : el.getElements()) {</span>
<span class="fc" id="L605">            element.visit(this);</span>
<span class="fc" id="L606">        }</span>
<span class="fc" id="L607">    }</span>

    @Override
    public void visit(final ElementDataset el) {
<span class="nc" id="L611">        LOGGER.trace(&quot;VISIT DATASET: {}&quot;, el);</span>
<span class="nc" id="L612">        throw new NotImplementedException(&quot;DATASET&quot;);</span>
    }

    @Override
    public void visit(final ElementNamedGraph el) {
<span class="nc" id="L617">        LOGGER.trace(&quot;VISIT NAMED GRAPH: {}&quot;, el);</span>
<span class="nc" id="L618">        throw new NotImplementedException(&quot;NAMED GRAPH&quot;);</span>
    }

    @Override
    public void visit(final ElementExists el) {
<span class="nc" id="L623">        LOGGER.trace(&quot;VISIT EXISTS: {}&quot;, el);</span>
<span class="nc" id="L624">        throw new NotImplementedException(&quot;EXISTS&quot;);</span>
    }

    @Override
    public void visit(final ElementNotExists el) {
<span class="nc" id="L629">        LOGGER.trace(&quot;VISIT NOT EXISTS: {}&quot;, el);</span>
<span class="nc" id="L630">        throw new NotImplementedException(&quot;NOT EXISTS&quot;);</span>
    }

    @Override
    public void visit(final ElementMinus el) {
<span class="nc" id="L635">        LOGGER.trace(&quot;VISIT MINUS: {}&quot;, el);</span>
<span class="nc" id="L636">        throw new NotImplementedException(&quot;MINUS&quot;);</span>
    }

    @Override
    public void visit(final ElementService el) {
<span class="nc" id="L641">        LOGGER.trace(&quot;VISIT SERVICE: {}&quot;, el);</span>
<span class="nc" id="L642">        throw new NotImplementedException(&quot;SERVICE&quot;);</span>
    }

    @Override
    public void visit(final ElementSubQuery el) {
<span class="nc" id="L647">        LOGGER.trace(&quot;VISIT SUBQUERY: {}&quot;, el);</span>
<span class="nc" id="L648">        throw new NotImplementedException(&quot;SUB QUERY&quot;);</span>
    }

    @Override
    public void startVisit() {
<span class="nc" id="L653">    }</span>

    @Override
    public void visit(final ExprFunction0 func) {
<span class="nc" id="L657">        LOGGER.trace(&quot;VISIT EXPRFUNCTION0: {}&quot;, func);</span>
<span class="nc" id="L658">    }</span>

    @Override
    public void visit(final ExprFunction1 func) {
<span class="fc" id="L662">        LOGGER.trace(&quot;VISIT EXPRFUNCTION1: {}&quot;, func);</span>
<span class="fc" id="L663">        final String funcName = func.getFunctionSymbol().getSymbol().toLowerCase();</span>

        try {
<span class="pc bpc" id="L666" title="7 of 10 branches missed.">            switch (funcName) {</span>
                case &quot;not&quot;:
<span class="fc" id="L668">                    final JQLQueryVisitor subVisitor1 = new JQLQueryVisitor(this);</span>
<span class="fc" id="L669">                    func.getArg().visit(subVisitor1);</span>
<span class="fc" id="L670">                    appendConstraint(queryFactory.not(subVisitor1.getConstraint()));</span>
<span class="fc" id="L671">                    break;</span>
                case &quot;bound&quot;:
<span class="nc" id="L673">                    final Column column = variables.get(func.getArg().getVarName());</span>
<span class="nc" id="L674">                    appendConstraint(queryFactory.propertyExistence(column.getSelectorName(),</span>
                                                                    column.getPropertyName()));
<span class="nc" id="L676">                    break;</span>
                default:
<span class="nc" id="L678">                    throw new NotImplementedException(funcName);</span>
            }

<span class="nc" id="L681">        } catch (final RepositoryException e) {</span>
<span class="nc" id="L682">            LOGGER.info(&quot;Got exception visiting ExprFunction1 method {}&quot;, funcName, e);</span>
<span class="fc" id="L683">        }</span>
<span class="fc" id="L684">    }</span>

    @Override
    public void visit(final ExprFunction2 func) {
<span class="fc" id="L688">        LOGGER.trace(&quot;VISIT EXPRFUNCTION2: {}&quot;, func);</span>
<span class="fc" id="L689">        final String funcName = func.getFunctionSymbol().getSymbol().toLowerCase();</span>

        try {
<span class="fc bfc" id="L692" title="All 4 branches covered.">            if (funcName.equals(&quot;and&quot;) || funcName.equals(&quot;or&quot;)) {</span>
<span class="fc" id="L693">                final JQLQueryVisitor subVisitor1 = new JQLQueryVisitor(this);</span>
<span class="fc" id="L694">                func.getArg1().visit(subVisitor1);</span>


<span class="fc" id="L697">                final JQLQueryVisitor subVisitor2 = new JQLQueryVisitor(this);</span>
<span class="fc" id="L698">                func.getArg2().visit(subVisitor2);</span>

<span class="pc bpc" id="L700" title="4 of 10 branches missed.">                switch (funcName) {</span>
                    case &quot;and&quot;:
<span class="fc" id="L702">                        appendConstraint(queryFactory.and(subVisitor1</span>
                                .getConstraint(), subVisitor2.getConstraint()));
<span class="fc" id="L704">                        break;</span>
                    case &quot;or&quot;:
<span class="fc" id="L706">                        appendConstraint(queryFactory.or(subVisitor1</span>
                                .getConstraint(), subVisitor2.getConstraint()));
<span class="fc" id="L708">                        break;</span>
                    default:
<span class="nc" id="L710">                        throw new NotImplementedException(funcName);</span>
                }
<span class="pc bpc" id="L712" title="1 of 2 branches missed.">            } else if (!func.getArg2().isConstant()) {</span>
<span class="nc" id="L713">                throw new NotImplementedException(</span>
                        &quot;EXPRFUNCTION2 2nd argument must be a constant: &quot;
                                + func.getArg1() + &quot;; &quot; + func.getArg2());
            } else {
                final String op;
<span class="fc" id="L718">                String value = func.getArg2().getConstant().getString();</span>
<span class="pc bpc" id="L719" title="20 of 38 branches missed.">                switch(funcName) {</span>
                    case &quot;eq&quot;:
<span class="fc" id="L721">                        op = JCR_OPERATOR_EQUAL_TO;</span>
<span class="fc" id="L722">                        break;</span>
                    case &quot;ge&quot;:
<span class="fc" id="L724">                        op = JCR_OPERATOR_GREATER_THAN_OR_EQUAL_TO;</span>
<span class="fc" id="L725">                        break;</span>
                    case &quot;le&quot;:
<span class="nc" id="L727">                        op = JCR_OPERATOR_LESS_THAN_OR_EQUAL_TO;</span>
<span class="nc" id="L728">                        break;</span>
                    case &quot;lt&quot;:
<span class="fc" id="L730">                        op = JCR_OPERATOR_LESS_THAN;</span>
<span class="fc" id="L731">                        break;</span>
                    case &quot;gt&quot;:
<span class="nc" id="L733">                        op = JCR_OPERATOR_GREATER_THAN;</span>
<span class="nc" id="L734">                        break;</span>
                    case &quot;ne&quot;:
<span class="nc" id="L736">                        op = JCR_OPERATOR_NOT_EQUAL_TO;</span>
<span class="nc" id="L737">                        break;</span>
                    case &quot;contains&quot;:
<span class="fc" id="L739">                        op = JCR_OPERATOR_LIKE;</span>
<span class="fc" id="L740">                        value = &quot;%&quot; + value + &quot;%&quot;;</span>
<span class="fc" id="L741">                        break;</span>
                    case &quot;strstarts&quot;:
<span class="fc" id="L743">                        op = JCR_OPERATOR_LIKE;</span>
<span class="fc" id="L744">                        value = value + &quot;%&quot;;</span>
<span class="fc" id="L745">                        break;</span>
                    case &quot;strends&quot;:
<span class="fc" id="L747">                        op = JCR_OPERATOR_LIKE;</span>
<span class="fc" id="L748">                        value = &quot;%&quot; + value;</span>
<span class="fc" id="L749">                        break;</span>
                    default:
<span class="nc" id="L751">                        throw new NotImplementedException(funcName);</span>
                }

<span class="fc" id="L754">                appendConstraint(queryFactory.comparison(getPropertyValue(func</span>
                        .getArg1()), op, queryFactory.literal(getValue(value))));

            }

<span class="nc" id="L759">        } catch (final RepositoryException e) {</span>
<span class="nc" id="L760">            throw propagate(e);</span>
<span class="fc" id="L761">        }</span>


<span class="fc" id="L764">    }</span>

    @Override
    public void visit(final ExprFunction3 func) {
<span class="nc" id="L768">        LOGGER.trace(&quot;VISIT EXPRFUNCTION3: {}&quot;, func);</span>
<span class="nc" id="L769">    }</span>

    @Override
    public void visit(final ExprFunctionN func) {
<span class="fc" id="L773">        LOGGER.trace(&quot;VISIT EXPRFUNCTIONN: {}&quot;, func);</span>
        try {
<span class="fc" id="L775">            final FunctionLabel functionSymbol = func.getFunctionSymbol();</span>
<span class="fc" id="L776">            final List&lt;Expr&gt; args = func.getArgs();</span>

<span class="fc" id="L778">            final String symbol = functionSymbol.getSymbol().toLowerCase();</span>
<span class="pc bpc" id="L779" title="1 of 2 branches missed.">            if (symbol.equals(&quot;regex&quot;)) {</span>
<span class="fc" id="L780">                final Expr expr = args.get(0);</span>

<span class="pc bpc" id="L782" title="1 of 2 branches missed.">                if (expr.isVariable()) {</span>
<span class="fc" id="L783">                    appendConstraint(queryFactory.comparison(</span>
                            getPropertyValue(expr), JCR_OPERATOR_LIKE,
                            queryFactory.literal(getValue(args.get(1)))));
                } else {
<span class="nc" id="L787">                    throw new NotImplementedException(&quot;ExprFunctionN &quot; + symbol);</span>
                }

<span class="fc" id="L790">            } else {</span>
<span class="nc" id="L791">                throw new NotImplementedException(&quot;ExprFunctionN &quot; + symbol);</span>
            }

<span class="nc" id="L794">        } catch (final RepositoryException e) {</span>
<span class="nc" id="L795">            throw propagate(e);</span>
<span class="fc" id="L796">        }</span>
<span class="fc" id="L797">    }</span>

    @Override
    public void visit(final ExprFunctionOp funcOp) {
<span class="nc" id="L801">        LOGGER.trace(&quot;VISIT EXPRFUNCTIONOp: {}&quot;, funcOp);</span>
<span class="nc" id="L802">    }</span>

    @Override
    public void visit(final NodeValue nv) {
<span class="nc" id="L806">        LOGGER.trace(&quot;VISIT NODEVALUE: {}&quot;, nv);</span>
<span class="nc" id="L807">    }</span>

    @Override
    public void visit(final ExprVar nv) {
<span class="nc" id="L811">        LOGGER.trace(&quot;VISIT EXPRVAR: {}&quot;, nv);</span>
<span class="nc" id="L812">    }</span>

    @Override
    public void visit(final ExprAggregator eAgg) {
<span class="nc" id="L816">        LOGGER.trace(&quot;VISIT EXPRAGGREGATOR: {}&quot;, eAgg);</span>
<span class="nc" id="L817">    }</span>

    @Override
    public void finishVisit() {
<span class="nc" id="L821">    }</span>

    private PropertyValue getPropertyValue(final Column column) {
        try {
<span class="fc" id="L825">            return queryFactory.propertyValue(column.getSelectorName(), column.getPropertyName());</span>
<span class="nc" id="L826">        } catch (final RepositoryException e) {</span>
<span class="nc" id="L827">            throw propagate(e);</span>
        }
    }

    private PropertyValue getPropertyValue(final Expr expr) {
<span class="fc" id="L832">        return getPropertyValue(variables.get(expr.getVarName()));</span>
    }

    private Value getValue(final Expr e) throws RepositoryException {
<span class="fc" id="L836">        return getValue(e.getConstant().asString());</span>
    }

    private Value getValue(final String e) throws RepositoryException {
<span class="fc" id="L840">        return session.getValueFactory().createValue(e);</span>
    }

    private void appendConstraint(final Constraint c) throws RepositoryException {
<span class="fc bfc" id="L844" title="All 2 branches covered.">        if (constraint == null) {</span>
<span class="fc" id="L845">            constraint = c;</span>
        } else {
<span class="fc" id="L847">            constraint = queryFactory.and(constraint, c);</span>
        }
<span class="fc" id="L849">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.4.201312101107</span></div></body></html>